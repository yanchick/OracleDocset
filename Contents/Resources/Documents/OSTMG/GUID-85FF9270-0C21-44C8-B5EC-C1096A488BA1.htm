<!DOCTYPE html><html lang="en-US"><head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="UTF-8"/>
<a class="dashingAutolink" name="autolink-86879"></a><a class="dashAnchor" name="//apple_ref/cpp/Package/Migrating%20the%20Database%20to%20Oracle%20ASM%20Using%20RMAN"></a><title>Migrating the Database to Oracle ASM Using RMAN</title>
<meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"/>
<meta name="dcterms.created" content="2017-07-10T10:06:05Z"/>
<meta name="robots" content="all"/>
<meta name="dcterms.title" content="Automatic Storage Management Administrator&#39;s Guide"/>
<meta name="dcterms.identifier" content="E41058-12"/>
<meta name="dcterms.isVersionOf" content="OSTMG"/>
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2007, 2017, Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved."/>
<link rel="Start" href="../index.htm" title="Home" type="text/html"/>
<link rel="Copyright" href="../dcommon/html/cpyr.htm" title="Copyright" type="text/html"/>

<script type="application/javascript" src="../dcommon/js/headfoot.js"></script>
<script type="application/javascript" src="../nav/js/doccd.js" charset="UTF-8"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html"/>
<link rel="Index" href="index.htm" title="Index" type="text/html"/>
<link rel="Prev" href="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D.htm" title="Previous" type="text/html"/>
<link rel="Next" href="GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63.htm" title="Next" type="text/html"/>
<link rel="alternate" href="E41058-12.pdf" title="PDF version" type="application/pdf"/>
<link rel="schema.dcterms" href="http://purl.org/dc/terms/"/>
<link rel="stylesheet" href="../dcommon/css/fusiondoc.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/header.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/footer.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/fonts.css"/>
<link rel="stylesheet" href="../dcommon/css/foundation.css"/>
<link rel="stylesheet" href="../dcommon/css/codemirror.css"/>
<link rel="stylesheet" type="text/css" title="Default" href="../nav/css/html5.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-480-tablet.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-768-laptop.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-1140-deskop.css"/>
<script type="application/javascript" src="../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="/s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns" dir="ltr">
<a id="BEGIN" name="BEGIN"></a>
<a id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1"></a> <span id="PAGE" style="display:none;">240/612</span> <!-- End Header -->
<a id="OSTMG94244"></a><a id="OSTMG12121"></a>
<h1 id="OSTMG-GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1" class="sect1">Migrating the Database to Oracle ASM Using RMAN</h1>
<div>
<p><a id="d63602e131" class="indexterm-anchor"></a><a id="d63602e135" class="indexterm-anchor"></a>The following procedure is intended to minimize database downtime. The steps differ slightly depending on whether you are migrating a primary or standby database. The procedure makes the same assumptions described in <span class="q">&#34;<a href="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D.htm">Preparing to Migrate the Database to Oracle ASM Using RMAN</a>&#34;</span>. If you are not migrating the recovery area to Oracle ASM, then you must modify some steps, which are noted.</p>
<div class="infobox-note" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-F6A61E3E-6516-41E5-8AC7-41A90415B200">
<p class="notep1">Note:</p>
<p>The following procedure switches between SQL*Plus and RMAN, so keep a terminal window open for each utility.</p>
</div>
<p>To migrate the database to Oracle ASM:</p>
<ol>
<li>
<p>Follow the steps in <span class="q">&#34;<a href="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D.htm">Preparing to Migrate the Database to Oracle ASM Using RMAN</a>&#34;</span>.</p>
</li>
<li>
<p>Restore or create a server parameter file in Oracle ASM storage.</p>
<p>The steps depend on whether the database is using a server parameter file:</p>
<ul style="list-style-type: disc;">
<li>
<p>If the database is using a server parameter file, then restore it to the Oracle ASM disk group with the following commands, where <span class="italic"><code class="codeph">sid</code></span> is the SID of the instance:</p>
<pre dir="ltr">RMAN&gt; STARTUP MOUNT;
RMAN&gt; RESTORE SPFILE TO &#39;+DATA/spfile<span class="italic">sid</span>.ora&#39;;
RMAN&gt; SHUTDOWN IMMEDIATE;
</pre></li>
<li>
<p>If the database is not using a server parameter file, then create one in Oracle ASM. Run the <code class="codeph">CREATE SPFILE</code> command in SQL*Plus as follows, where <span class="italic"><code class="codeph">sid</code></span> is the SID of the database:</p>
<pre dir="ltr">SQL&gt; CREATE SPFILE=&#39;+DATA/spfile<span class="italic">sid</span>.ora&#39; FROM PFILE=&#39;?/dbs/init<span class="italic">sid</span>.ora&#39;;
</pre></li>
</ul>
</li>
<li id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__BAJCGAFE">
<p>Set Oracle Managed Files initialization parameters to Oracle ASM locations.</p>
<div class="infobox-note" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-65F747BA-B195-4A7D-97A0-3C1E2BA2BA32">
<p class="notep1">Note:</p>
<p>If you are not migrating the fast recovery area, then do not change the <code class="codeph">DB_RECOVERY_FILE_DEST</code> and <code class="codeph">DB_RECOVERY_FILE_DEST_SIZE</code> initialization parameter settings. However, you must set <code class="codeph">DB_CREATE_ONLINE_LOG_DEST_</code><span class="italic"><code class="codeph">n</code></span> parameter to an Oracle ASM location for migration of the online redo logs.</p>
</div>
<p>Set the <code class="codeph">DB_CREATE_FILE_DEST</code> and optional <code class="codeph">DB_CREATE_ONLINE_LOG_DEST_</code><span class="italic"><code class="codeph">n</code></span> initialization parameters to Oracle ASM disk groups. If the database uses a recovery area, then change the recovery area location to the Oracle ASM disk group. Also, change the recovery area size.</p>
<p>Run commands in SQL*Plus as shown in the following example. The example assumes that the size of the fast recovery area is 100 GB and specifies the disk group <code class="codeph">+FRA</code> for the fast recovery area.</p>
<pre dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET DB_CREATE_FILE_DEST=&#39;+DATA&#39; SID=&#39;*&#39;;
SQL&gt; ALTER SYSTEM SET DB_RECOVERY_FILE_DEST_SIZE=100G SID=&#39;*&#39;;
SQL&gt; ALTER SYSTEM SET DB_RECOVERY_FILE_DEST=&#39;+FRA&#39; SID=&#39;*&#39;;
</pre></li>
<li>
<p>Set the <code class="codeph">CONTROL_FILES</code> initialization parameter to Oracle ASM locations.</p>
<p>If you are migrating the fast recovery area, then enter the following commands in SQL*Plus to restart the database instance and set the control file locations to disk groups <code class="codeph">+DATA</code> and <code class="codeph">+FRA</code>:</p>
<pre dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET CONTROL_FILES=&#39;+DATA&#39;,&#39;+FRA&#39; SCOPE=SPFILE SID=&#39;*&#39;;
</pre>
<p>If you are not migrating the fast recovery area, then enter the following commands in SQL*Plus to restart the database instance and set the control file locations to disk group <code class="codeph">+DATA</code>:</p>
<pre dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET CONTROL_FILES=&#39;+DATA&#39;,&#39;+DATA&#39; SCOPE=SPFILE SID=&#39;*&#39;;
</pre></li>
<li>
<p>Migrate the control file to Oracle ASM and mount the control file.</p>
<p>Switch to the RMAN terminal to restore the control file. In the following example, <span class="italic"><code class="codeph">original_cf_name</code></span> is a control file name in the initialization parameter file before migration:</p>
<pre dir="ltr">RMAN&gt; STARTUP FORCE NOMOUNT;
RMAN&gt; RESTORE CONTROLFILE FROM &#39;<span class="italic">original_cf_name</span>&#39;;
RMAN&gt; ALTER DATABASE MOUNT;
</pre></li>
<li>
<p>Migrate the data files to Oracle ASM.</p>
<p>Use RMAN to switch to the database copy that you created in step <a href="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D.htm#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D__BAJHEEDG">5</a> &#34;Back up the data files to the Oracle ASM disk group&#34; in <span class="q">&#34;<a href="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D.htm">Preparing to Migrate the Database to Oracle ASM Using RMAN</a>&#34;</span>. The switch renames all the data files to files on Oracle ASM disk groups. Afterward, recover the database. If incremental backups were taken, then RMAN applies them during recovery. For example, enter the following commands at the RMAN prompt:</p>
<pre dir="ltr">SWITCH DATABASE TO COPY;
RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;
  RECOVER DATABASE;
}
</pre></li>
<li>
<p>If the database uses block change tracking or Flashback Database, then enable these features.</p>
<div class="infobox-note" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-1925625F-780B-442E-B533-8FA5234F2A2F">
<p class="notep1">Note:</p>
<p>If you are not migrating the recovery area, then you do not enable Flashback Database unless you had disabled it previously.</p>
</div>
<p>For example, enter the following statements in SQL*Plus:</p>
<pre dir="ltr">SQL&gt; ALTER DATABASE ENABLE BLOCK CHANGE TRACKING USING FILE &#39;+DATA&#39;;
SQL&gt; ALTER DATABASE FLASHBACK ON;
</pre></li>
<li>
<p>Place the database in its normal operation mode.</p>
<p>The normal operational mode depends on whether the database is a primary or standby database:</p>
<ul style="list-style-type: disc;">
<li>
<p>If the database is a primary database, then open it as follows:</p>
<pre dir="ltr">SQL&gt; ALTER DATABASE OPEN;
</pre></li>
<li>
<p>If the database is a standby database, then resume managed recovery mode as follows:</p>
<pre dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE;
</pre></li>
</ul>
</li>
<li>
<p>Drop the tempfiles and re-create them in Oracle ASM.</p>
<p>Use SQL*Plus to re-create the tempfiles. In the following example, the name of the tempfile in the original storage is <span class="italic"><code class="codeph">tempfile_name</code></span>. The name of the temporary tablespace is <span class="italic"><code class="codeph">temp_tbs_name</code></span>.</p>
<pre dir="ltr">SQL&gt; ALTER DATABASE TEMPFILE &#39;<span class="italic">tempfile_name</span>&#39; DROP;
SQL&gt; ALTER TABLESPACE <span class="italic">temp_tbs_name</span> ADD TEMPFILE;
</pre></li>
<li>
<p>Migrate the online redo log files.</p>
<p>If this is a primary database, then add new log group members in Oracle ASM and drop the old members. You can use the following PL/SQL script to migrate the online redo log groups into an Oracle ASM disk group. The PL/SQL script assumes that the Oracle Managed Files initialization parameters specified in step <a href="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1.htm#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__BAJCGAFE">3</a> &#34;Set Oracle Managed Files initialization parameters to Oracle ASM locations&#34; in <span class="q">&#34;<a href="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1.htm#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">Migrating the Database to Oracle ASM Using RMAN</a>&#34;</span> are set.</p>
</li>
<li>
<p>Optionally, migrate backups and copies in the old fast recovery area to Oracle ASM as follows:</p>
<ol>
<li>
<p>If foreign archived logs exists in the recovery area, then you cannot migrate them to Oracle ASM. Run the following command at the RMAN prompt:</p>
<pre dir="ltr">RMAN&gt; DELETE ARCHIVELOG ALL;
</pre></li>
<li>
<p>Back up archived redo log files, backup sets, and data file copies to Oracle ASM. For example, run the following command at the RMAN prompt:</p>
<pre dir="ltr">RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;

  BACKUP AS COPY ARCHIVELOG ALL DELETE INPUT;
  BACKUP BACKUPSET ALL DELETE INPUT;
  BACKUP AS COPY DATAFILECOPY ALL DELETE INPUT;
}
</pre></li>
</ol>
</li>
</ol>
<div class="example" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-24DD750B-790F-4360-A6BF-0C5D04AD7D8A">
<p class="titleinexample">Example 8-1 Migrating the online redo logs</p>
<pre dir="ltr">SET SERVEROUTPUT ON;
DECLARE
   CURSOR rlc IS
      SELECT GROUP# GRP, THREAD# THR, BYTES, &#39;NO&#39; SRL
      FROM   V$LOG
      UNION
      SELECT GROUP# GRP, THREAD# THR, BYTES, &#39;YES&#39; SRL
      FROM   V$STANDBY_LOG
      ORDER BY 1;
   stmt     VARCHAR2(2048);
BEGIN
   FOR rlcRec IN rlc LOOP
      IF (rlcRec.srl = &#39;YES&#39;) THEN
         stmt := &#39;ALTER DATABASE ADD STANDBY LOGFILE THREAD &#39; ||
                 rlcRec.thr || &#39; SIZE &#39; || rlcRec.bytes;
         EXECUTE IMMEDIATE stmt;
         stmt := &#39;ALTER DATABASE DROP STANDBY LOGFILE GROUP &#39; || rlcRec.grp;
         EXECUTE IMMEDIATE stmt;
      ELSE
         stmt := &#39;ALTER DATABASE ADD LOGFILE THREAD &#39; ||
                 rlcRec.thr || &#39; SIZE &#39; ||  rlcRec.bytes;
         EXECUTE IMMEDIATE stmt;
         BEGIN
            stmt := &#39;ALTER DATABASE DROP LOGFILE GROUP &#39; || rlcRec.grp;
            DBMS_OUTPUT.PUT_LINE(stmt);
            EXECUTE IMMEDIATE stmt;
         EXCEPTION
            WHEN OTHERS THEN
               EXECUTE IMMEDIATE &#39;ALTER SYSTEM SWITCH LOGFILE&#39;;
               EXECUTE IMMEDIATE &#39;ALTER SYSTEM CHECKPOINT GLOBAL&#39;;
               EXECUTE IMMEDIATE stmt;
         END;
      END IF;
   END LOOP;
END;
/
</pre></div>
<!-- class="example" --></div>
</div>
<!-- class="ind" --><!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment1687">
<tr>
<td class="cellalignment1694">
<table class="cellalignment1692">
<tr>
<td class="cellalignment1691"><a href="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D.htm"><img width="24" height="24" src="../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment1691"><a href="GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63.htm"><img width="24" height="24" src="../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2007, 2017, Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment1696">
<table class="cellalignment1690">
<tr>
<td class="cellalignment1691"><a href="../index.htm"><img width="24" height="24" src="../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment1691"><a href="../nav/portal_booklist.htm"><img width="24" height="24" src="../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment1691"><a href="toc.htm"><img width="24" height="24" src="../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment1691"><a href="index.htm"><img width="24" height="24" src="../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment1691"><a href="../nav/mindx.htm"><img width="24" height="24" src="../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment1691"><a href="../dcommon/html/feedback.htm"><img width="24" height="24" src="../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>


</body></html>