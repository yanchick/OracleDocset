<!DOCTYPE html><html lang="en"><head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<meta charset="utf-8"/>
<a class="dashingAutolink" name="autolink-77863"></a><a class="dashAnchor" name="//apple_ref/cpp/Package/Multithreaded%20Applications"></a><title>Multithreaded Applications</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Merged Version 1023"/>
<meta name="dcterms.created" content="2014-07-06T20:23:26Z"/>
<meta name="robots" content="all"/>
<meta name="dcterms.title" content="Pro*COBOL&reg; Programmer&#39;s Guide"/>
<meta name="dcterms.identifier" content="E53282-01"/>
<meta name="dcterms.isVersionOf" content="LNPCB"/>
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;1996, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved."/>
<link rel="Start" href="../index.htm" title="Home" type="text/html"/>
<link rel="Copyright" href="../dcommon/html/cpyr.htm" title="Copyright" type="text/html"/>

<script type="application/javascript" src="../dcommon/js/headfoot.js"></script>
<script type="application/javascript" src="../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html"/>
<link rel="Index" href="index.htm" title="Index" type="text/html"/>
<link rel="Prev" href="pco11ody.htm" title="Previous" type="text/html"/>
<link rel="Next" href="pco13lob.htm" title="Next" type="text/html"/>
<link rel="alternate" href="E53282-01.pdf" title="PDF version" type="application/pdf"/>
<link rel="schema.dcterms" href="http://purl.org/dc/terms/"/>
<link rel="stylesheet" href="../dcommon/css/fusiondoc.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/header.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/footer.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/fonts.css"/>
<link rel="stylesheet" href="../dcommon/css/foundation.css"/>
<link rel="stylesheet" href="../dcommon/css/codemirror.css"/>
<link rel="stylesheet" type="text/css" title="Default" href="../nav/css/html5.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-480-tablet.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-768-laptop.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-1140-deskop.css"/>
<script type="application/javascript" src="../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="/s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">18/27</span> <!-- End Header -->
<div id="LNPCB785" class="chapter"><a id="g1009413"></a> <a id="i1005728"></a>
<h1 class="chapter"><span class="secnum">12</span> Multithreaded Applications</h1>
<p>If your development platform does not support threads, you can ignore this chapter.</p>
<p>The sections of this chapter are:</p>
<ul>
<li>
<p><a href="#i999793">Introduction to Threads</a></p>
</li>
<li>
<p><a href="#i997959">Runtime Contexts in Pro*COBOL</a></p>
</li>
<li>
<p><a href="#i1005576">Runtime Context Usage Models</a></p>
</li>
<li>
<p><a href="#i998619">User Interface Features for Multithreaded Applications</a></p>
</li>
<li>
<p><a href="#i998635">Multithreaded Example</a></p>
</li>
</ul>
<a id="i999793"></a>
<div id="LNPCB786" class="sect1">
<h2 class="sect1">Introduction to Threads</h2>
<p>Multithreaded applications have multiple <span class="italic">threads</span> executing in a shared address space. Threads are &#34;lightweight&#34; subprocesses that execute within a process. They share code and data segments, but have their own program counters, machine registers, and stack. Variables declared without the thread-local attribute in working storage (as opposed to local-storage or thread-local storage) are common to all threads, and a mutual exclusivity mechanism is often required to manage access to these variables from multiple threads within an application. <span class="italic">Mutexes</span> are the synchronization mechanism to insure that data integrity is preserved.</p>
<p>For further discussion of mutexes, see texts on multithreading. For more detailed information about multithreaded applications, see the documentation of your threads functions.</p>
<p>Pro*COBOL supports development of multithreaded Oracle Server applications (on platforms that support multithreaded applications) using the following:</p>
<ul>
<li>
<p>A command-line option to generate thread-safe code.</p>
</li>
<li>
<p>Embedded SQL statements and directives to support multithreading.</p>
</li>
<li>
<p>Thread-safe SQLLIB and other client-side Oracle libraries.</p>
</li>
</ul>
<div class="infobox-note">
<p class="notep1">Note:</p>
While your platform may support a particular thread package, see your platform-specific Oracle documentation to determine whether Oracle supports it.</div>
<p>The chapter&#39;s topics discuss how to use the preceding features to develop multithreaded Pro*COBOL applications:</p>
<ul>
<li>
<p>Runtime contexts for multithreaded applications.</p>
</li>
<li>
<p>Two models for using runtime contexts.</p>
</li>
<li>
<p>User-interface features for multithreaded applications.</p>
</li>
<li>
<p>Programming considerations for writing multithreaded applications with Pro*COBOL.</p>
</li>
<li>
<p>Sample multithreaded Pro*COBOL applications.</p>
</li>
</ul>
</div>
<!-- class="sect1" -->
<a id="i997959"></a>
<div id="LNPCB787" class="sect1">
<h2 class="sect1">Runtime Contexts in Pro*COBOL</h2>
<p>To loosely couple a thread and a connection, in Pro*COBOL we introduce the concept of a <span class="italic">runtime context</span>. The runtime context includes the following resources and their current states:</p>
<ul>
<li>
<p>Zero or more connections to one or more Oracle servers.</p>
</li>
<li>
<p>Zero or more cursors used for the server connections.</p>
</li>
<li>
<p>Inline options, such as MODE, HOLD_CURSOR, RELEASE_CURSOR, and SELECT_ERROR.</p>
</li>
</ul>
<p>Rather than simply supporting a loose coupling between threads and connections, Pro*COBOL enables you to loosely couple threads with runtime contexts. Pro*COBOL enables your application to define a handle to a runtime context, and pass that handle from one thread to another.</p>
<p>For example, an interactive application spawns a thread, T1, to execute a query and return the first 10 rows to the application. T1 then terminates. After obtaining the necessary user input, another thread, T2, is spawned (or an existing thread is used) and the runtime context for T1 is passed to T2 so it can fetch the next 10 rows by processing the same cursor.This is shown in <a href="#i1005570">Figure 12-1</a>:</p>
<div id="LNPCB788" class="figure">
<p class="titleinfigure"><a id="i1005570"></a>Figure 12-1 Loosely Coupling Connections and Threads</p>
<img width="443" height="527" src="img/pc_81021.gif" alt="Loose Coupling"/><br/>
<a id="sthref1571" href="img_text/pc_81021.htm">Description of &#34;Figure 12-1 Loosely Coupling Connections and Threads&#34;</a><br/>
<br/></div>
<!-- class="figure" --></div>
<!-- class="sect1" -->
<a id="i1005576"></a>
<div id="LNPCB789" class="sect1">
<h2 class="sect1">Runtime Context Usage Models</h2>
<p>Two possible models for using runtime contexts in multithreaded applications are shown here:</p>
<ul>
<li>
<p>Multiple threads sharing a single runtime context.</p>
</li>
<li>
<p>Multiple threads using separate runtime contexts.</p>
</li>
</ul>
<p>Regardless of the model you use for runtime contexts, you <span class="italic">cannot</span> share a runtime context between multiple threads <span class="italic">at the same time</span>. If two or more threads attempt to use the same runtime context simultaneously, a runtime error occurs</p>
<div id="LNPCB790" class="sect2"><a id="sthref1572"></a>
<h3 class="sect2">Multiple Threads Sharing a Single Runtime Context</h3>
<p><a href="#i1005537">Figure 12-2</a> shows an application running in a multithreaded environment. The various threads share a single runtime context to process one or more SQL statements. Again, runtime contexts cannot be shared by multiple threads at the same time. The mutexes in <a href="#i1005537">Figure 12-2</a> show how to prevent concurrent usage.</p>
<div id="LNPCB791" class="figure">
<p class="titleinfigure"><a id="i1005537"></a>Figure 12-2 Context Sharing Among Threads</p>
<img width="496" height="416" src="img/pc_81023.gif" alt="Context Sharing"/><br/>
<a id="sthref1573" href="img_text/pc_81023.htm">Description of &#34;Figure 12-2 Context Sharing Among Threads&#34;</a><br/>
<br/></div>
<!-- class="figure" --></div>
<!-- class="sect2" -->
<div id="LNPCB792" class="sect2"><a id="sthref1574"></a>
<h3 class="sect2">Multiple Threads Sharing Multiple Runtime Contexts</h3>
<p><a href="#i997998">Figure 12-3</a> shows an application that executes multiple threads using multiple runtime contexts. In this situation, the application does not require mutexes, because each thread has a dedicated runtime context.</p>
<div id="LNPCB793" class="figure">
<p class="titleinfigure"><a id="i997998"></a>Figure 12-3 No Context Sharing Among Threads</p>
<img width="496" height="518" src="img/pc_81022.gif" alt="No Context Sharing"/><br/>
<a id="sthref1575" href="img_text/pc_81022.htm">Description of &#34;Figure 12-3 No Context Sharing Among Threads&#34;</a><br/>
<br/></div>
<!-- class="figure" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i998619"></a>
<div id="LNPCB794" class="sect1">
<h2 class="sect1">User Interface Features for Multithreaded Applications</h2>
<p>Pro*COBOL provides the following user-interface features to support multithreaded applications:</p>
<ul>
<li>
<p>Host variables can be declared in the LOCAL-STORAGE and the THREAD-LOCAL-STORAGE sections.</p>
</li>
<li>
<p>The command-line option THREADS=YES | NO.</p>
</li>
<li>
<p>Embedded SQL statements and directives.</p>
</li>
<li>
<p>Thread-safe SQLLIB public functions.</p>
</li>
</ul>
<div id="LNPCB795" class="sect2"><a id="sthref1576"></a>
<h3 class="sect2">THREADS Option<a id="sthref1577"></a><a id="sthref1578"></a></h3>
<p>With THREADS=YES specified on the command line, Pro*COBOL ensures that the generated code is thread-safe, given that you follow the guidelines described in <a href="#i999517">&#34;Multithreading Programming Considerations&#34;</a>. With THREADS=YES specified, Pro*COBOL verifies that all SQL statements execute within the scope of a user-defined runtime context. If your program does not meet this requirement, a precompiler error is returned.</p>
</div>
<!-- class="sect2" -->
<a id="i998018"></a>
<div id="LNPCB796" class="sect2">
<h3 class="sect2"><a id="sthref1579"></a>Embedded SQL Statements and Directives for Runtime Contexts</h3>
<p>The following embedded SQL statements and directives support the definition and usage of runtime contexts and threads:</p>
<ul>
<li>
<p>EXEC SQL ENABLE THREADS END-EXEC.</p>
</li>
<li>
<p>EXEC SQL CONTEXT ALLOCATE :<span class="italic">context_var</span> END-EXEC.</p>
</li>
<li>
<p>EXEC SQL CONTEXT USE { :<span class="italic">context_var</span> | DEFAULT} END-EXEC.</p>
</li>
<li>
<p>EXEC SQL CONTEXT FREE :<span class="italic">context_var</span> END-EXEC.</p>
</li>
</ul>
<p>For these EXEC SQL statements, <span class="italic">context_var</span> is the handle to the runtime context and must be declared of type <a id="sthref1580"></a>SQL-CONTEXT as follows:</p>
<pre> 01  SQL-CONTEXT <span class="italic">context_var</span> END-EXEC.
</pre>
<p>Using DEFAULT means that the default (global) runtime context will be used in all embedded SQL statements that lexically follow until another CONTEXT USE statement overrides it.</p>
<p>Examples illustrating the various uses of context statements are shown.</p>
<div id="LNPCB797" class="sect3"><a id="sthref1581"></a>
<h4 class="sect3"><a id="sthref1582"></a>Host Tables of SQL-CONTEXT Are Not Allowed</h4>
<p>You cannot declare host tables of SQL-CONTEXT. Instead, declare a host table of S9(9) COMP variables and then pass them to the subprogram one at a time after redeclaring them in the subprogram as SQL-CONTEXT.</p>
</div>
<!-- class="sect3" -->
<a id="i999743"></a>
<div id="LNPCB798" class="sect3">
<h4 class="sect3"><span class="bold">EXEC SQL ENABLE THREADS<a id="sthref1583"></a><a id="sthref1584"></a><a id="sthref1585"></a><a id="sthref1586"></a></span></h4>
<p>This executable SQL statement initializes a process that supports multiple threads. This must be the first executable SQL statement in a program that contains a multithreaded application. There can only be one ENABLE THREADS statement in all files of an application, or an error results. For more detailed information, see <a href="pcoafemb.htm#i26109">&#34;ENABLE THREADS (Executable Embedded SQL Extension)&#34;</a>.</p>
</div>
<!-- class="sect3" -->
<div id="LNPCB799" class="sect3"><a id="sthref1587"></a>
<h4 class="sect3"><span class="bold">EXEC SQL CONTEXT ALLOCATE<a id="sthref1588"></a><a id="sthref1589"></a><a id="sthref1590"></a><a id="sthref1591"></a></span></h4>
<p>This executable SQL statement allocates and initializes memory for the specified runtime context; the runtime-context variable must be declared of type SQL_CONTEXT. For more detailed information, see <a href="pcoafemb.htm#i18514">&#34;CONTEXT ALLOCATE (Executable Embedded SQL Extension)&#34;</a>.</p>
</div>
<!-- class="sect3" -->
<div id="LNPCB800" class="sect3"><a id="sthref1592"></a>
<h4 class="sect3">EXEC SQL CONTEXT USE</h4>
<p><a id="sthref1593"></a><a id="sthref1594"></a><a id="sthref1595"></a><a id="sthref1596"></a><a id="sthref1597"></a>The EXEC SQL CONTEXT USE directive instructs the precompiler to use the specified runtime context for subsequent executable SQL statements. The runtime context specified must be previously allocated using an EXEC SQL CONTEXT ALLOCATE statement.</p>
<p>The EXEC SQL CONTEXT USE directive works similarly to the EXEC SQL WHENEVER directive in that it affects all executable SQL statements which positionally follow it in a given source file without regard to standard COBOL scope rules.</p>
<p>For more detailed information, see <a href="pcoafemb.htm#i18529">&#34;CONTEXT USE (Oracle Embedded SQL Directive)&#34;</a>, and <a href="pcoafemb.htm#i18514">&#34;CONTEXT ALLOCATE (Executable Embedded SQL Extension)&#34;</a>.</p>
</div>
<!-- class="sect3" -->
<div id="LNPCB801" class="sect3"><a id="sthref1598"></a>
<h4 class="sect3"><span class="bold">EXEC SQL CONTEXT FREE<a id="sthref1599"></a><a id="sthref1600"></a><a id="sthref1601"></a><a id="sthref1602"></a></span></h4>
<p>The EXEC SQL CONTEXT FREE executable SQL statement frees the memory associated with the specified runtime context and places a null pointer in the host program variable. For more detailed information, see <a href="pcoafemb.htm#i18524">&#34;CONTEXT FREE (Executable Embedded SQL Extension)&#34;</a>.</p>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<div id="LNPCB802" class="sect2"><a id="sthref1603"></a>
<h3 class="sect2">Communication with Pro*C/C++ Programs</h3>
<p>Runtime contexts can be passed using arguments defined in the Linkage Section. Multithreaded Pro*C/C++ programs can call Pro*COBOL subprograms and Pro*COBOL programs can call subprograms written in Pro*C/C++.</p>
</div>
<!-- class="sect2" -->
<a id="i999517"></a>
<div id="LNPCB803" class="sect2">
<h3 class="sect2">Multithreading Programming Considerations</h3>
<p>While Oracle ensures that the SQLLIB code is thread-safe, you are responsible for ensuring that your source code is designed to work properly with threads. For example, carefully consider the scope of the variables you use.</p>
<p>In addition, multithreading requires design decisions regarding the following:</p>
<ul>
<li>
<p>Including one SQLCA for each runtime context.</p>
</li>
<li>
<p>Declaring the SQLDA as a thread-safe group item, like the SQLCA, typically an auto variable, one for each runtime context.</p>
</li>
<li>
<p>Declaring host variables in a thread-safe fashion, in other words, carefully consider your use of static and global host variables.</p>
</li>
<li>
<p>Avoiding simultaneous use of a runtime context in multiple threads.</p>
</li>
<li>
<p>Whether or not to use default database connections or to explicitly define them using the AT clause.</p>
</li>
</ul>
<p>No more than one executable embedded SQL statement, for example, EXEC SQL UPDATE, may be outstanding on a runtime context at a given time.</p>
<p>Existing requirements for precompiled applications also apply. For example, all references to a given cursor must appear in the same source file.</p>
<div id="LNPCB804" class="sect3"><a id="sthref1604"></a>
<h4 class="sect3">Restrictions on Multithreading</h4>
<p>The following restrictions be in effect when using threads:</p>
<ul>
<li>
<p>You cannot use an array of datatype SQL-CONTEXT.</p>
</li>
<li>
<p>Concurrent threads should each have its own SQLCA.</p>
</li>
<li>
<p>Concurrent threads should each have its own context areas.</p>
</li>
</ul>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<div id="LNPCB805" class="sect2"><a id="sthref1605"></a>
<h3 class="sect2">Multiple Context Examples</h3>
<p>The code fragments in this section show how to use multiple contexts, and demonstrate the scope of the context use statement.</p>
<div id="LNPCB806" class="sect3"><a id="sthref1606"></a>
<h4 class="sect3">Example 1</h4>
<p>In the first example, the precompiler option setting THREADS=YES is not needed, because we are not generating threads:</p>
<pre> IDENTIFICATION DIVISION.
 PROGRAM-ID. MAIN.
 ...
* declare a context area
 01  CTX1  SQL-CONTEXT.
 01  UID1  PIC X(11) VALUE &#34;SCOTT/TIGER&#34;.
 01  UID2  PIC X(10) VALUE &#34;MARY/LION&#34;

 PROCEDURE DIVISION.
...
* allocate context area
     EXEC SQL CONTEXT ALLOCATE :CTX1 END-EXEC.
     EXEC SQL CONTEXT USE :CTX1 END-EXEC.
* all statements until the next context use will use CTX1
     EXEC SQL CONNECT :UID1 END-EXEC.
     EXEC SQL SELECT ....
     EXEC SQL CONTEXT USE DEFAULT END-EXEC.
* all statements physically after the preceding lines will use the default context
     EXEC SQL CONNECT :UID2 END-EXEC.
     EXEC SQL INSERT ...
 ...
</pre></div>
<!-- class="sect3" -->
<div id="LNPCB807" class="sect3"><a id="sthref1607"></a>
<h4 class="sect3">Example 2</h4>
<p>This next example shows multiple contexts. One context is used by the generated thread while the other is used by the main program. The started thread, SUBPRGM1, will use context CTX1, which is passed to it through the LINKAGE SECTION. This example also demonstrates the scope of the CONTEXT USE statement.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
You must precompile the main program file, and the main program of every subsequent example in this section, with the option THREADS=YES.</div>
<pre> IDENTIFICATION DIVISION.
 PROGRAM-ID. MAIN.
 ...
* declare two context areas
 01  CTX1  SQL-CONTEXT.
 01  CTX2  SQL-CONTEXT.

 PROCEDURE DIVISION.

* enable threading
     EXEC SQL ENABLE THREADS END-EXEC.

* allocate context areas
     EXEC SQL CONTEXT ALLOCATE :CTX1 END-EXEC.
     EXEC SQL CONTEXT ALLOCATE :CTX2 END-EXEC.

* include your code to start thread &#34;SUBPGM1&#34; using CTX1 here.

     EXEC SQL CONTEXT USE :CTX2 END-EXEC.
* all statement physically after the preceding lines will use CTX2

     EXEC SQL CONNECT :USERID END-EXEC.
     EXEC SQL INSERT .....
 ...
</pre>
<p>The thread <code>SUBPRGM1</code> is in a another file:</p>
<pre> PROGRAM-ID. SUBPRGM1.
 ...
 01  USERID PIC X(11) VALUE &#34;SCOTT/TIGER&#34;.
 LINKAGE SECTION.
 01  CTX1 SQL-CONTEXT.
 PROCEDURE DIVISION USING CTX1.

     EXEC SQL CONTEXT USE :CTX1 END-EXEC.
     EXEC SQL CONNECT :USERID END-EXEC.
     EXEC SQL SELECT ...
 ...
</pre></div>
<!-- class="sect3" -->
<div id="LNPCB808" class="sect3"><a id="sthref1608"></a>
<h4 class="sect3">Example 3</h4>
<p>The following example uses multiple threads. Each thread has its own context. If the threads are to be executed concurrently, each thread <span class="italic">must</span> have its own context. Contexts are passed to the thread with the USING CLAUSE of the START statement and are declared in the LINKAGE SECTION of the threaded subprogram.</p>
<pre> IDENTIFICATION DIVISION.
 PROGRAM-ID. MAIN.
 ...
 DATA DIVISION.

 01  CTX1 SQL-CONTEXT.
 01  CTX2 SQL-CONTEXT.

 PROCEDURE DIVISION.
 ...
     EXEC SQL ENABLE THREADS END-EXEC.
     EXEC SQL CONTEXT ALLOCATE :CTX1 END-EXEC.
     EXEC SQL CONTEXT ALLOCATE :CTX2 END-EXEC.

* include your code to start thread &#34;SUBPGM&#34; using CTX1 here.
* include your code to start thread &#34;SUBPGM&#34; using CTX2 here.
 ...
</pre>
<p>The thread SUBPGM is placed in another file:</p>
<pre>PROGRAM-ID. SUBPGM.
 ...
 DATA DIVISION.
 ...
 01  USERID PIC X(11) VALUE &#34;SCOTT/TIGER&#34;.
 ...
 LINKAGE SECTION.
 01  CTX SQL-CONTEXT.
 PROCEDURE DIVISION USING CTX.
     EXEC SQL CONTEXT USE :CTX END-EXEC.
     EXEC SQL CONNECT :USERID END-EXEC.
     EXEC SQL SELECT ....
 ...
</pre></div>
<!-- class="sect3" -->
<div id="LNPCB809" class="sect3"><a id="sthref1609"></a>
<h4 class="sect3">Example 4</h4>
<p>The next example is based on the previous example, but does the connection in the top level program and passes the connection with the context to the threaded subprogram.</p>
<pre> IDENTIFICATION DIVISION.
 PROGRAM-ID. MAIN.
 ...
 DATA DIVISION.

 01  CTX1 SQL-CONTEXT.
 01  CTX2 SQL-CONTEXT.
 01  USERID PIC X(11) VALUE &#34;SCOTT/TIGER&#34;.

 ROCEDURE DIVISION.

     EXEC SQL ENABLE THREADS END-EXEC.
     EXEC SQL CONTEXT ALLOCATE :CTX1 END-EXEC.
     EXEC SQL CONTEXT ALLOCATE :CTX2 END-EXEC.
     EXEC SQL CONTEXT USE :CTX1 END-EXEC.
     EXEC SQL CONNECT :USERID END-EXEC.
     EXEC SQL CONTEXT USE :CTX2 END-EXEC.
     EXEC SQL CONNECT :USERID END-EXEC.

* include your code to start thread &#34;SUBPGM&#34; using CTX1 here.
* include your code to start thread &#34;SUBPGM&#34; using CTX2 here.
 ...
</pre>
<p>The thread <code>SUBPRGM</code> is in another file:</p>
<pre> PROGRAM-ID. SUBPGM.
 ...
 LINKAGE SECTION.
 01  CTX SQL-CONTEXT.
 PROCEDURE DIVISION USING CTX.
     EXEC SQL CONTEXT USE :CTX END-EXEC.
     EXEC SQL SELECT ....
 ...
</pre></div>
<!-- class="sect3" -->
<div id="LNPCB810" class="sect3"><a id="sthref1610"></a>
<h4 class="sect3">Example 5</h4>
<p>The following example shows multiple threads which share a context. Note that in this case, the threads <span class="italic">must</span> be serialized.</p>
<pre> IDENTIFICATION DIVISION.
 PROGRAM-ID. MAIN.
 ...
 DATA DIVISION.

 01  CTX1 SQL-CONTEXT.

 PROCEDURE DIVISION.

     EXEC SQL ENABLE THREADS END-EXEC.
     EXEC SQL CONTEXT ALLOCATE :CTX1 END-EXEC.

* include your code to start thread1 &#34;SUBPGM1&#34; using CTX1 here.
* include your code to wait for thread1 here.
* include your code to start thread2 &#34;SUBPGM2&#34; using CTX1 here.
 ...
</pre>
<p>There are two separate files for the two threads. First there is:</p>
<pre> PROGRAM-ID. SUBPGM1.
 ...
 DATA DIVISION.
 ..
 01  USERID PIC X(11) VALUE &#34;SCOTT/TIGER&#34;.
 ...
 LINKAGE SECTION.
 01  CTX SQL-CONTEXT.
 PROCEDURE DIVISION USING CTX.
     EXEC SQL CONTEXT USE :CTX END-EXEC.
 ...
     EXEC SQL CONNECT :USERID END-EXEC.
</pre>
<p>Another file contains SUBPGM2:</p>
<pre> PROGRAM-ID. SUBPGM2.
 ...
 DATA DIVISION.
 ...
 LINKAGE SECTION.
 01  CTX SQL-CONTEXT.
 PROCEDURE DIVISION USING CTX.
     EXEC SQL CONTEXT USE :CTX END-EXEC.
     EXEC SELECT ....
 ...
</pre></div>
<!-- class="sect3" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i998635"></a>
<div id="LNPCB811" class="sect1">
<h2 class="sect1">Multithreaded Example<a id="sthref1611"></a></h2>
<p>This multi-file application demonstrates one way to use the SQLLIB runtime context area (SQL-CONTEXT) to support multiple threads. Precompile with THREADS=YES.</p>
<p>The main program, orathrd2, declares an array of S9(9) COMP variables to be used to hold the sqllib contexts. It enables threading through the</p>
<pre>EXEC SQL ENABLE THREADS END-EXEC. 
</pre>
<p>statement and then calls the subprogram oracon (in file <code>oracon.pco</code>) to allocate the threads. oracon also establishes a connection for each allocated context.</p>
<p>Next, ORTHRD2 passes the context to one of the threaded entry points, THREAD-1 or THREAD-2. THREAD-1 simply selects and displays the salary for an employee. THREAD-2 selects and updates the salary for that employee. Since THREAD-2 issues a commit, the update is visible to threads that do the SELECT after it has committed. (But not those which run concurrently with the update.) Note that the output will vary from run to run because the timing of the update and commit is non-determinant.</p>
<p>It is important to remember that concurrent threads must each have their own contexts. Contexts may be passed to and used by subsequent threads, but threads may not use the same context concurrently. This model could be used for connection pooling, where the maximum number of connections are created initially and passed to threads as available, to execute user&#39;s requests.</p>
<p>An array of S9(9) COMP variables is used because you cannot currently declare an array of SQL-CONTEXT.</p>
<p><span class="bold">Note:</span> This program was developed specifically for a Sun workstation running Solaris and MicroFocus ServerExpress compiler and uses vendor-specific directives and functionality.</p>
<p>See your platform-specific documentation for the specific COBOL statements that support multithreading.</p>
<p>The main program is in file <code>orathrd2.pco</code>:</p>
<pre>      $SET REENTRANT MF
       IDENTIFICATION DIVISION.
       PROGRAM-ID. ORATHRD2.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       78 MAX-LOOPS            VALUE 10.
       01 THREAD-ID            USAGE POINTER.
       01 TP-1                 USAGE THREAD-POINTER OCCURS MAX-LOOPS.
       01 IDEN-4               PIC 9(4).
       01 LOOP-COUNTER         PIC 9(2)  COMP-X EXTERNAL.
       01 PEMPNO               PIC S9(4) COMP EXTERNAL.
       01 ISAL                 PIC S9(4) COMP   VALUE ZERO.
           EXEC SQL
                INCLUDE SQLCA
           END-EXEC.
       THREAD-LOCAL-STORAGE SECTION.
       01  CONTEXT-AREA          PIC S9(9) COMP OCCURS MAX-LOOPS.
       PROCEDURE DIVISION.
       MAIN SECTION.
                
           PERFORM INITIALISATION
           PERFORM ORACLE-CONNECTIONS VARYING LOOP-COUNTER
                   FROM 1 BY 1 UNTIL LOOP-COUNTER &gt; MAX-LOOPS
           PERFORM  VARYING LOOP-COUNTER FROM 1 BY 1
              UNTIL LOOP-COUNTER &gt; MAX-LOOPS
               PERFORM START-THREAD
           END-PERFORM
           STOP RUN.

      *---------------------------------------------------------------
      * CHECK THAT WE ARE RUNNING UNDER A MULTI THREADED RTS.
      *---------------------------------------------------------------
       INITIALISATION SECTION.

           CALL &#34;CBL_THREAD_SELF&#34; USING THREAD-ID ON EXCEPTION
                DISPLAY &#34;NO THREAD SUPPORT IN THIS RTS&#34;
                STOP RUN
           END-CALL
           IF RETURN-CODE = 1008
                DISPLAY &#34;CANNOT RUN THIS TEST ON SINGLE THREADED RTS&#34;
                STOP RUN
           END-IF
           DISPLAY &#34;MULTI-THREAD RTS&#34;

      * ENABLING THREADS MUST BE DONE ONCE BEFORE ANY CONTEXT USEAGE
           EXEC SQL ENABLE THREADS END-EXEC.
           IF SQLCODE NOT = ZERO
              DISPLAY &#39;ERROR ENABLING ORACLE THREAD SUPPORT &#39;
                      &#39; - ABORTING : &#39; SQLERRMC
              STOP RUN
           END-IF

      *  SET A VALUE FOR THE EMPLOYEE NUMBER.  BECAUSE THIS IS AN
      *  EXTERNAL VARIABLE, A COPY OF ITS VALUE IS VISIBLE TO THE 
      *  OTHER MODULES IN THIS APPLICATION
           MOVE 7566 TO PEMPNO
           EXIT SECTION.

      *-----------------------------------------------------------------
      * CREATE THREADS AND START WITH EITHER THREAD-1 OR THREAD-2
      *-----------------------------------------------------------------
       START-THREAD SECTION.

           IF LOOP-COUNTER = 2 OR LOOP-COUNTER = 5
              START &#34;THREAD-2 &#34;
                 USING CONTEXT-AREA(LOOP-COUNTER)
                 IDENTIFIED BY TP-1(LOOP-COUNTER)
                 STATUS IS IDEN-4
                 ON EXCEPTION DISPLAY &#34;THREAD CREATE FAILED&#34;
              END-START
              IF IDEN-4 NOT = ZERO
                DISPLAY &#34;THREAD CREATE FAILED RETURNED &#34; IDEN-4
              END-IF
           ELSE
              START &#34;THREAD-1 &#34;
                 USING CONTEXT-AREA(LOOP-COUNTER)
                 IDENTIFIED BY TP-1(LOOP-COUNTER)
                 STATUS IS IDEN-4
                 ON EXCEPTION DISPLAY &#34;THREAD CREATE FAILED&#34;
              END-START
              IF IDEN-4 NOT = ZERO
                DISPLAY &#34;THREAD CREATE FAILED RETURNED &#34; IDEN-4
              END-IF
           END-IF.

       START-THREAD-END.
           EXIT SECTION.


      *-----------------------------------------------------------------
      * ALLOCATE CONTEXT AREAS ESTABLISH CONNECTION WITH EACH AREA.
      *-----------------------------------------------------------------
       ORACLE-CONNECTIONS SECTION.

           CALL &#34;ORACON&#34; USING CONTEXT-AREA(LOOP-COUNTER).
       ORACLE-CONNECTIONS-END.
           EXIT SECTION.
</pre>
<p>Here is the file <code>thread-1.pco</code>:</p>
<pre>      * This is Thread 1.  It selects and displays the data for 
      * the employee. The context area upon which a connection
      * has been established is passed to the thread through the 
      * linkage section. In a multi-file application, you
      * can pass the context through the linkage section.  
      * Precompile with THREADS=YES.
      * 
      $SET REENTRANT MF
       IDENTIFICATION DIVISION.
       PROGRAM-ID. THREAD-1.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 PEMPNO               PIC S9(4) COMP EXTERNAL.

       LOCAL-STORAGE SECTION.
       01 DEMPNO               PIC Z(4) VALUE ZERO.
       01 PEMP-NAME1           PIC X(15) VARYING  VALUE SPACES.
       01 PSAL-VALUE1          PIC S9(7)V99 COMP-3 VALUE ZERO.
       01 ISAL1                PIC S9(4)   COMP   VALUE ZERO.
       01 DSAL-VALUE           PIC +(7).99 VALUE ZERO.
           EXEC SQL
                INCLUDE SQLCA
           END-EXEC.

       LINKAGE SECTION.
       01 CONTEXT-AREA1         SQL-CONTEXT.

      *---------------------------------------------------------------
      * USING THE PASSED IN CONTEXT, SELECT AND DISPLAY THE
      * DATA FOR EMPLOYEE.  
      *---------------------------------------------------------------
       PROCEDURE DIVISION USING CONTEXT-AREA1.
       MAIN SECTION.

           EXEC SQL WHENEVER SQLERROR GOTO SELECT-ERROR END-EXEC
           EXEC SQL CONTEXT USE :CONTEXT-AREA1 END-EXEC
           EXEC SQL
                SELECT  ENAME, SAL
                  INTO  :PEMP-NAME1, :PSAL-VALUE1:ISAL1
                  FROM  EMP
                 WHERE  EMPNO = :PEMPNO
           END-EXEC
           IF ISAL1 &lt; ZERO
              MOVE ZERO     TO PSAL-VALUE1
           END-IF
           MOVE PEMPNO      TO DEMPNO
           MOVE PSAL-VALUE1 TO DSAL-VALUE
           DISPLAY &#34;FOR EMP &#34;, DEMPNO, &#34; NAME &#34;,
                   PEMP-NAME1-ARR(1:PEMP-NAME1-LEN),
                   &#34; THE CURRENT SALARY IS &#34;, DSAL-VALUE
           EXIT PROGRAM.


      *---------------------------------------------------------------
      * THERE HAS BEEN AN ERROR WHEN SELECTING FROM THE EMP TABLE
      *---------------------------------------------------------------
       SELECT-ERROR SECTION.

           EXEC SQL WHENEVER SQLERROR CONTINUE END-EXEC
           DISPLAY &#34;HIT AN ORACLE ERROR SELECTING EMPNO 7566&#34;
           DISPLAY &#34;SQLCODE = &#34;, SQLCODE
           DISPLAY &#34;ERROR TEXT &#34;, SQLERRMC(1:SQLERRML)
           GOBACK
           EXIT SECTION.
</pre>
<p>Here is the file <code>thread-2.pco</code>:</p>
<pre>      * This is Thread 2.  The program will select, then update,
      * increment, and then commit the salary.  It uses the passed-in 
      * context upon which a connection has previously been established.
      * Precompile with THREADS=YES.
      *
      $SET REENTRANT MF
       IDENTIFICATION DIVISION.
       PROGRAM-ID. THREAD-2.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 PEMPNO               PIC S9(4)   COMP EXTERNAL.

       LOCAL-STORAGE SECTION.
       01 DEMPNO               PIC Z(4) VALUE ZERO.
       01 PEMP-NAME2           PIC X(15) VARYING  VALUE SPACES.
       01 PSAL-VALUE2          PIC S9(7)V99 COMP-3 VALUE 100.
       01 ISAL2                PIC S9(4)   COMP   VALUE ZERO.
       01 DSAL-VALUE           PIC +(7).99 VALUE ZERO.
           EXEC SQL
                INCLUDE SQLCA
           END-EXEC.

       LINKAGE SECTION.
       01 CONTEXT-AREA2         SQL-CONTEXT.

      *---------------------------------------------------------------
      * USING THE PASSED IN CONTEXT AREA, FIRST SELECT TO GET INITIAL
      * VALUES, INCREMENT THE SALARY, UPDATE AND COMMIT.
      *---------------------------------------------------------------
       PROCEDURE DIVISION USING CONTEXT-AREA2.
       MAIN SECTION.

           EXEC SQL WHENEVER SQLERROR GOTO UPDATE-ERROR END-EXEC
           EXEC SQL CONTEXT USE     :CONTEXT-AREA2 END-EXEC
           EXEC SQL
                SELECT  ENAME, SAL
                  INTO  :PEMP-NAME2, :PSAL-VALUE2:ISAL2
                  FROM  EMP
                 WHERE  EMPNO = :PEMPNO
           END-EXEC
           ADD  10  TO PSAL-VALUE2
           EXEC SQL
                   UPDATE  EMP
                      SET  SAL   = :PSAL-VALUE2
                    WHERE  EMPNO = :PEMPNO
           END-EXEC
           MOVE PEMPNO      TO DEMPNO
           MOVE PSAL-VALUE2 TO DSAL-VALUE
           DISPLAY &#34;FOR EMP &#34;, DEMPNO, &#34; NAME &#34;,
                   PEMP-NAME2-ARR(1:PEMP-NAME2-LEN),
                   &#34; THE UPDATED SALARY IS &#34;, DSAL-VALUE
      *    THIS COMMIT IS REQUIRED, OTHERWISE THE DATABASE
      *    WILL BLOCK SINCE THE UPDATES ARE TO THE SAME ROW
           EXEC SQL COMMIT WORK END-EXEC
           EXIT PROGRAM.

      *---------------------------------------------------------------
      * THERE HAS BEEN AN ERROR WHEN UPDATING THE SAL IN THE EMP TABLE
      *---------------------------------------------------------------
       UPDATE-ERROR SECTION.

           EXEC SQL WHENEVER SQLERROR CONTINUE END-EXEC
           DISPLAY &#34;HIT AN ORACLE ERROR UPDATING EMPNO 7566&#34;
           DISPLAY &#34;SQLCODE = &#34;, SQLCODE
           DISPLAY &#34;ERROR TEXT &#34;, SQLERRMC(1:SQLERRML)
           GOBACK
           EXIT SECTION.

</pre>
<p>The file <code>oracon.pco</code> follows:</p>
<pre>      * This program allocates SQLLIB runtime contexts, stores
      * a pointer to the context in the variable which was
      * passed in from the main program through the linkage section,
      * and establishes a connection on the allocated context.
      *
      * This program is written for Merant MicroFocus COBOL and uses
      * vendor-specific directives and functionality. Precompile
      * with THREADS=YES.
      *
      $SET REENTRANT MF
       IDENTIFICATION DIVISION.
       PROGRAM-ID. ORACON.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 LOGON-STRING         PIC X(40)          VALUE SPACES.
           EXEC SQL
                INCLUDE SQLCA
           END-EXEC.
       LINKAGE SECTION.
       01  CONTEXT          SQL-CONTEXT.

       PROCEDURE DIVISION USING CONTEXT.
       MAIN SECTION.
                
      *-----------------------------------------------------------------
      * ALLOCATE CONTEXT AREAS ESTABLISH CONNECTION WITH EACH AREA.
      *-----------------------------------------------------------------
       ORACLE-CONNECTION SECTION.

           MOVE &#34;SCOTT/TIGER&#34;  TO LOGON-STRING
           EXEC SQL CONTEXT ALLOCATE :CONTEXT END-EXEC
           IF SQLCODE NOT = ZERO
              DISPLAY &#39;ERROR ALLOCATING CONTEXT &#39;
                      &#39;- ABORTING : &#39; SQLERRMC
              GOBACK
           ELSE
              DISPLAY &#39;CONTEXT ALLOCATED&#39;
           END-IF

           EXEC SQL CONTEXT USE :CONTEXT END-EXEC
           EXEC SQL  CONNECT    :LOGON-STRING  END-EXEC
           IF SQLCODE NOT = ZERO
              DISPLAY &#39;ERROR CONNECTING SECOND THREAD TO THE DATABASE &#39;
                      &#39;- ABORT TEST : &#39; SQLERRMC
              GOBACK
           ELSE
              DISPLAY &#39;CONNECTION ESTABLISHED&#39;
           END-IF
           EXIT SECTION.
</pre></div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment4964">
<tr>
<td class="cellalignment4973">
<table class="cellalignment4969">
<tr>
<td class="cellalignment4968"><a href="pco11ody.htm"><img width="24" height="24" src="../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment4968"><a href="pco13lob.htm"><img width="24" height="24" src="../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;1996, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment4976">
<table class="cellalignment4967">
<tr>
<td class="cellalignment4968"><a href="../index.htm"><img width="24" height="24" src="../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment4968"><a href="../nav/portal_booklist.htm"><img width="24" height="24" src="../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment4968"><a href="toc.htm"><img width="24" height="24" src="../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment4968"><a href="index.htm"><img width="24" height="24" src="../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment4968"><a href="../nav/mindx.htm"><img width="24" height="24" src="../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment4968"><a href="../dcommon/html/feedback.htm"><img width="24" height="24" src="../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>


</body></html>