<!DOCTYPE html><html lang="en"><head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<meta charset="utf-8"/>
<a class="dashingAutolink" name="autolink-106342"></a><a class="dashAnchor" name="//apple_ref/cpp/Package/Query%20Performance%20and%20Prefetching"></a><title>Query Performance and Prefetching</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 743"/>
<meta name="dcterms.created" content="2014-02-04T21:52:15Z"/>
<meta name="robots" content="all"/>
<meta name="dcterms.title" content="Database 2 Day + PHP Developer&#39;s Guide"/>
<meta name="dcterms.identifier" content="E18554-05"/>
<meta name="dcterms.isVersionOf" content="TDPPH"/>
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2010, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved."/>
<link rel="Start" href="../index.htm" title="Home" type="text/html"/>
<link rel="Copyright" href="../dcommon/html/cpyr.htm" title="Copyright" type="text/html"/>

<script type="application/javascript" src="../dcommon/js/headfoot.js"></script>
<script type="application/javascript" src="../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html"/>
<link rel="Index" href="index.htm" title="Index" type="text/html"/>
<link rel="Prev" href="ch_seven_error.htm" title="Previous" type="text/html"/>
<link rel="Next" href="ch_nine_insert.htm" title="Next" type="text/html"/>
<link rel="alternate" href="E18554-05.pdf" title="PDF version" type="application/pdf"/>
<link rel="schema.dcterms" href="http://purl.org/dc/terms/"/>
<link rel="stylesheet" href="../dcommon/css/fusiondoc.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/header.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/footer.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/fonts.css"/>
<link rel="stylesheet" href="../dcommon/css/foundation.css"/>
<link rel="stylesheet" href="../dcommon/css/codemirror.css"/>
<link rel="stylesheet" type="text/css" title="Default" href="../nav/css/html5.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-480-tablet.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-768-laptop.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-1140-deskop.css"/>
<script type="application/javascript" src="../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="/s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">11/18</span> <!-- End Header -->
<div id="TDPPH168" class="chapter"><a id="CBAFDDEF"></a>
<h1 class="chapter"><span class="secnum">8</span> Query Performance and Prefetching</h1>
<p>This chapter contains the following topics:</p>
<ul>
<li>
<p><a href="#CBACHJDG">Prefetching Overview</a></p>
</li>
<li>
<p><a href="#CBAIEDIA">The Employee Report Page</a></p>
</li>
<li>
<p><a href="#CBAJFIHA">Running the Equipment Report</a></p>
</li>
<li>
<p><a href="#CBACGAAH">REF CURSOR Prefetching</a></p>
</li>
</ul>
<a id="CBACHJDG"></a>
<div id="TDPPH169" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Prefetching Overview</h2>
<p>This section shows how the performance of fetching query rows can be tuned in PHP.</p>
<p>Prefetching is the way that PHP OCI8 reduces network round-trips to the database when fetching query results. By retrieving batches of rows, there is better database and network efficiency.</p>
<p>Prefetching is enabled by default in PHP OCI8. When the first row is initially retrieved from the database, up to the configured limit (100 by default) extra rows up will be returned and stored in an internal buffer local to the PHP process. Any of the PHP OCI8 <code>oci_fetch_*</code> functions called in a script will internally use data from that buffer until it is exhausted, at which point another round trip to the database occurs and a further batch of rows is returned. The way the <code>oci_fetch_*</code> functions return data to the caller does not change regardless of the prefetch value in effect.</p>
<p>The default prefetch value can be set with <code>oci8.default_prefetch</code> in the <code>php.ini</code> configuration file, or it can be set at run time with <code>oci_set_prefetch()</code>.</p>
<p>So far the AnyCo application has used <code>oci_fetch_all()</code>. For a change, this chapter will show the other commonly used function, <code>oci_fetch_array()</code>. When this is called in a loop, it iterates through all rows in the query result set. For bigger data sets, fetching one row at a time prevents a large amount of memory being needed to hold the whole result set.</p>
<p>The action and benefits of prefetching would not be changed if <code>oci_fetch_all()</code> was used. Prefetching is handled in the Oracle client libraries at a layer below PHP.</p>
</div>
<!-- class="sect1" -->
<a id="CBAIEDIA"></a>
<div id="TDPPH170" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">The Employee Report Page</h2>
<p>Create a new PHP file <code>ac_report.php</code> that generates a report of all employees and the equipment issued to them. The file initially looks like:</p>
<pre>&lt;?php
 
/**
 * ac_report.php: Full report of all employees and their equipment
 * @package Report
 */
 
session_start();
require(&#39;ac_db.inc.php&#39;);
require(&#39;ac_equip.inc.php&#39;);
 
$sess = new \Equipment\Session;
$sess-&gt;getSession();
if (!isset($sess-&gt;username) || empty($sess-&gt;username)
        || !$sess-&gt;isPrivilegedUser()) {
    header(&#39;Location: index.php&#39;);
    exit;
}
 
$page = new \Equipment\Page;
$page-&gt;printHeader(&#34;AnyCo Corp. Equipment Report&#34;);
$page-&gt;printMenu($sess-&gt;username, $sess-&gt;isPrivilegedUser());
printcontent($sess);
$page-&gt;printFooter();
 
// Functions
 
?&gt;
</pre>
<p>In the <code>Functions</code> section add the <code>printcontent()</code> function:</p>
<pre>/**
 * Print the main body of the page
 *
 * @param Session $sess
 */
function printcontent($sess) {
    echo &#34;&lt;div id=&#39;content&#39;&gt;&#34;;
    $db = new \Oracle\Db(&#34;Equipment&#34;, $sess-&gt;username);
 
    $sql = &#34;select first_name || &#39; &#39; || last_name as emp_name, equip_name
        from employees left outer join equipment
        on employees.employee_id = equipment.employee_id
        order by emp_name, equip_name&#34;;
 
    // Change the prefetch value to compare performance.
    // Zero will be slowest. The system default is 100
    $db-&gt;setPrefetch(200);
 
    $time = microtime(true);
    $db-&gt;execute($sql, &#34;Equipment Report&#34;);
    echo &#34;&lt;table&gt;&#34;;
    while (($row = $db-&gt;fetchRow()) != false) {
        $empname = htmlspecialchars($row[&#39;EMP_NAME&#39;], ENT_NOQUOTES, &#39;UTF-8&#39;);
        $equipname = htmlspecialchars($row[&#39;EQUIP_NAME&#39;], ENT_NOQUOTES, &#39;UTF-8&#39;);
        echo &#34;&lt;tr&gt;&lt;td&gt;$empname&lt;/td&gt;&lt;td&gt;$equipname&lt;/td&gt;&lt;/tr&gt;&#34;;
    }
    echo &#34;&lt;/table&gt;&#34;;
    $time = microtime(true) - $time;
    echo &#34;&lt;p&gt;Report generated in &#34; . round($time, 3) . &#34; seconds\n&#34;;
    echo &#34;&lt;/div&gt;&#34;;  // content
}
</pre>
<p>The structure is basically similar to the layout shown in previous chapters.</p>
<p>The <code>$db-&gt;setPrefetch()</code> call is used to set the prefetch value. The <code>microtime()</code> calls are used to show how long the report took to generate.</p>
<p>A new <code>Db::fetchRow()</code> method is used to get one row at a time. It is called in a loop after the query has been run.</p>
<p>Edit <code>ac_db.inc.php</code> and add the <code>setPrefetch()</code> and <code>fetchRow()</code> methods to the <code>Db</code> class:</p>
<pre>    /**
     * Set the query prefetch row count to tune performance by reducing the
     * number of round trips to the database.  Zero means there will be no
     * prefetching and will be slowest.  A negative value will use the php.ini
     * default value.  Some queries such as those using LOBS will not have
     * rows prefetched.
     *
     * @param integer $pf The number of rows that queries should prefetch.
     */
    public function setPrefetch($pf) {
        $this-&gt;prefetch = $pf;
    }
 
    /**
     * Fetch a row of data.  Call this in a loop after calling Db::execute()
     *
     * @return array An array of data for one row of the query
     */
    public function fetchRow() {
        $row = oci_fetch_array($this-&gt;stid, OCI_ASSOC + OCI_RETURN_NULLS);
        return($row);
    }
</pre>
<p>The <code>OCI_ASSOC</code> flag tells PHP to return the results in an associative array, using the column names as the array keys. The <code>OCI_RETURN_NULLS</code> flag tells PHP to return an array entry for null data values. The value will be an empty string. This ensures that the array for each row has the same number of entries.</p>
</div>
<!-- class="sect1" -->
<a id="CBAJFIHA"></a>
<div id="TDPPH171" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Running the Equipment Report</h2>
<p>Save all the files and run the Application as Administrator. From the left hand navigation menu select <span class="bold">Equipment Report</span>. It shows all employees and the equipment they have been issued.</p>
<img width="906" height="377" src="img/chap8_pref_over.png" alt="Prefetching in PHP OCI8"/><br/>
<p>At the bottom is the amount of time taken to generate the query output. For this amount of data and because PHP and the database are not separated by a network, the time will be small:</p>
<img width="906" height="203" src="img/chap8_rep_1.png" alt="Running the Equipment Report"/><br/>
<p>To show the effect of turning off prefetching, edit <code>ac_report.php</code> and change the prefetch setting to <code>0</code>:</p>
<pre>  $db-&gt;setPrefetch(0);
</pre>
<p>This means that each row of data that PHP OCI8 gets from the Oracle Client libraries initiates a round-trip request to the database server. No extra rows are prefetched.</p>
<p>Re-run the report. The elapsed time should be longer.</p>
<img width="906" height="143" src="img/chap8_rep_2.png" alt="Running the Equipment Report"/><br/>
<p>For a small system like this there might be some test variability and the values may be too small to be reliable. Re-run several times or change the query to return more rows if so.</p>
</div>
<!-- class="sect1" -->
<a id="CBACGAAH"></a>
<div id="TDPPH172" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">REF CURSOR Prefetching</h2>
<p>Prefetching can also be used when fetching records from <code>REF CURSORS</code>. To make the <code>REF CURSOR</code> prefetch value changeable in the <code>Db</code> class, edit <code>ac_db.inc.php</code> and add the following lines before the <code>REF CURSOR</code> execution in <code>Db::refcurExecFetchAll()</code>:</p>
<pre>        if ($this-&gt;prefetch &gt;= 0) {
            oci_set_prefetch($rc, $this-&gt;prefetch);  // set on the REFCURSOR
        }
</pre>
<p>This prefetch size is set on the <code>REF CURSOR</code>, not the top level statement. The function will look as follows:</p>
<pre>    public function refcurExecFetchAll($sql, $action, $rcname, 
    $otherbindvars = array()) {
        $this-&gt;stid = oci_parse($this-&gt;conn, $sql);
        $rc = oci_new_cursor($this-&gt;conn);
        oci_bind_by_name($this-&gt;stid, $rcname, $rc, -1, OCI_B_CURSOR);
        foreach ($otherbindvars as $bv) {
            // oci_bind_by_name(resource, bv_name, php_variable, length)
            oci_bind_by_name($this-&gt;stid, $bv[0], $bv[1], $bv[2]);
        }
        oci_set_action($this-&gt;conn, $action);
        oci_execute($this-&gt;stid);
        <span class="bold">if ($this-&gt;prefetch &gt;= 0) {</span>
            <span class="bold">oci_set_prefetch($rc, $this-&gt;prefetch);  // set on the REFCURSOR</span>
        <span class="bold">}</span>
        oci_execute($rc); // run the ref cursor as if it were a statement id
        oci_fetch_all($rc, $res);
        return($res);
    }
</pre>
<p>With your own applications, testing will show the optimal prefetch size for your queries. There is no benefit in using too large a value. Conversely, because Oracle dynamically allocates space, there is little to be gained by making the value too small.</p>
<p>It is unlikely that you want to turn pre-fetching completely off. The only case would be in PHP code that gets a <code>REF CURSOR</code>, fetches some data from it, and then passes the cursor back to a PL/SQL procedure which fetches the remaining data. If prefetching occurred when PHP fetches records from the <code>REF CURSOR</code>, but those prefetched rows were not returned to the script through an <code>oci_fetch_*</code> call, those rows would be &#34;lost&#34; and would not be available to the second PL/SQL procedure.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
PHP must be linked with Oracle Database 11gR2 libraries for prefetching from <code>REF CURSOR</code> to work. When using earlier versions each requested <code>REF CURSOR</code> row required a round-trip to the database, reducing performance of the system.</div>
</div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment4949">
<tr>
<td class="cellalignment4956">
<table class="cellalignment4954">
<tr>
<td class="cellalignment4953"><a href="ch_seven_error.htm"><img width="24" height="24" src="../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment4953"><a href="ch_nine_insert.htm"><img width="24" height="24" src="../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2010, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment4958">
<table class="cellalignment4952">
<tr>
<td class="cellalignment4953"><a href="../index.htm"><img width="24" height="24" src="../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment4953"><a href="../nav/portal_booklist.htm"><img width="24" height="24" src="../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment4953"><a href="toc.htm"><img width="24" height="24" src="../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment4953"><a href="index.htm"><img width="24" height="24" src="../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment4953"><a href="../nav/mindx.htm"><img width="24" height="24" src="../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment4953"><a href="../dcommon/html/feedback.htm"><img width="24" height="24" src="../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>


</body></html>