<!DOCTYPE html><html lang="en"><head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<meta charset="utf-8"/>
<a class="dashingAutolink" name="autolink-106344"></a><a class="dashAnchor" name="//apple_ref/cpp/Package/Paging%20Through%20Employee%20Data"></a><title>Paging Through Employee Data</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 743"/>
<meta name="dcterms.created" content="2014-02-04T21:52:15Z"/>
<meta name="robots" content="all"/>
<meta name="dcterms.title" content="Database 2 Day + PHP Developer&#39;s Guide"/>
<meta name="dcterms.identifier" content="E18554-05"/>
<meta name="dcterms.isVersionOf" content="TDPPH"/>
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2010, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved."/>
<link rel="Start" href="../index.htm" title="Home" type="text/html"/>
<link rel="Copyright" href="../dcommon/html/cpyr.htm" title="Copyright" type="text/html"/>

<script type="application/javascript" src="../dcommon/js/headfoot.js"></script>
<script type="application/javascript" src="../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html"/>
<link rel="Index" href="index.htm" title="Index" type="text/html"/>
<link rel="Prev" href="ch_four_anyco_app.htm" title="Previous" type="text/html"/>
<link rel="Next" href="ch_six_ref_cur.htm" title="Next" type="text/html"/>
<link rel="alternate" href="E18554-05.pdf" title="PDF version" type="application/pdf"/>
<link rel="schema.dcterms" href="http://purl.org/dc/terms/"/>
<link rel="stylesheet" href="../dcommon/css/fusiondoc.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/header.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/footer.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/fonts.css"/>
<link rel="stylesheet" href="../dcommon/css/foundation.css"/>
<link rel="stylesheet" href="../dcommon/css/codemirror.css"/>
<link rel="stylesheet" type="text/css" title="Default" href="../nav/css/html5.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-480-tablet.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-768-laptop.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-1140-deskop.css"/>
<script type="application/javascript" src="../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="/s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">8/18</span> <!-- End Header -->
<div id="TDPPH159" class="chapter"><a id="sthref140"></a>
<h1 class="chapter"><span class="secnum">5</span> Paging Through Employee Data</h1>
<p>This chapter creates the main display page of the AnyCo application as shown in <a href="ch_one.htm#BABGJGFJ">Figure 1-1, &#34;Overview of the Sample Application&#34;</a>. It will show five employee records at a time and allow you to page through the list of employees.</p>
<p>This chapter contains the following topics:</p>
<ul>
<li>
<p><a href="#BABBICFE">Creating the Employee Listing</a></p>
</li>
<li>
<p><a href="#BABHEHGJ">Running the Employee List</a></p>
</li>
</ul>
<a id="BABBICFE"></a>
<div class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Creating the Employee Listing</h2>
<p>Create a new PHP file <code>ac_emp_list.php</code> initially containing:</p>
<pre>&lt;?php
 
/**
 * ac_emp_list.php: list of employees
 * @package Employee
 */
 
define(&#39;NUMRECORDSPERPAGE&#39;, 5);
 
session_start();
require(&#39;ac_db.inc.php&#39;);
require(&#39;ac_equip.inc.php&#39;);
 
$sess = new \Equipment\Session;
$sess-&gt;getSession();
if (!isset($sess-&gt;username) || empty($sess-&gt;username)) {
    header(&#39;Location: index.php&#39;);
    exit;
}
 
$page = new \Equipment\Page;
$page-&gt;printHeader(&#34;AnyCo Corp. Employees List&#34;);
$page-&gt;printMenu($sess-&gt;username, $sess-&gt;isPrivilegedUser());
printcontent($sess, calcstartrow($sess));
$page-&gt;printFooter();
 
// Functions
 
?&gt;
</pre>
<p>The <a id="sthref141"></a><a id="sthref142"></a><code>NUMRECORDSPERPAGE</code> constant determines how many employee records to show.</p>
<p>After the <a id="sthref143"></a><code>$sess-&gt;getSession()</code> call retrieves the stored session data there is some basic validation to confirm the user is authorized to view this page. Here the only requirement is that the <code>username</code> is set. If it is not set, the browser is redirected to the login page, <code>index.php</code>. Here is where a production application would do more validation, perhaps checking a timestamp and forcing users to re-login after a certain idle period. The user name could have been encrypted, making it harder for a hacker to view session data or to impersonate a session.</p>
<p>The body of the file prints the HTML page header, menu, content and footer of the page.</p>
<p>Th<a id="sthref144"></a><a id="sthref145"></a><a id="sthref146"></a>is file will show PHP&#39;s traditional procedural style instead of continuing the object oriented approach previously used. Under the <code>Functions</code> comment add the function to print the page content:</p>
<pre>/**
 * Print the main body of the page
 *
 * @param Session <a id="sthref147"></a><a id="sthref148"></a>$sess
 * @param integer <a id="sthref149"></a><a id="sthref150"></a>$startrow The first row of the table to be printed
 */
function printcontent($sess, $startrow) {
    echo &#34;&lt;div id=&#39;content&#39;&gt;&#34;;
 
    $db = new \Oracle\Db(&#34;Equipment&#34;, $sess-&gt;username);
    $sql = &#34;SELECT employee_id, first_name || &#39; &#39; || last_name AS name,
            phone_number FROM employees ORDER BY employee_id&#34;;
    $res = $db-&gt;execFetchPage($sql, &#34;Equipment Query&#34;, $startrow,
           NUMRECORDSPERPAGE);
    if ($res) {
        printrecords($sess, ($startrow === 1), $res);
    } else {
        printnorecords();
    }
 
    echo &#34;&lt;/div&gt;&#34;;  // content
    // Save the session, including the current data row number
    $sess-&gt;empstartrow = $startrow;
    $sess-&gt;setSession();
}
</pre>
<p>This runs a query on the <code>EMPLOYEES</code> table. The <a id="sthref151"></a><a id="sthref152"></a><code>Db::execFetchPage()</code> method is similar to <code><a id="sthref153"></a><a id="sthref154"></a>Db::execFetchAll()</code> and will be shown in a moment. If there are records to display then <code>printrecords()</code> will show them, else <code><a id="sthref155"></a><a id="sthref156"></a><a id="sthref157"></a>printnorecords()</code> will display a message that there was nothing to show. The final stage of printing the content is to update the session with the new starting row number.</p>
<p>The call to <code><a id="sthref158"></a><a id="sthref159"></a><a id="sthref160"></a>printcontent()</code> at the top level uses <code><a id="sthref161"></a><a id="sthref162"></a><a id="sthref163"></a>calcstartrow()</code> to decide which row number to start at. Add this function to <code>ac_emp_list.php</code>:</p>
<pre>/**
 * Return the row number of the first record to display.
 *
 * The calculation is based on the current position
 * and whether the Next or Previous buttons were clicked
 *
 * @param Session $sess
 * @return integer The row number that the page should start at
 */
function calcstartrow($sess) {
    if (empty($sess-&gt;empstartrow)) {
        $startrow = 1;
    } else {
        $startrow = $sess-&gt;empstartrow;
        if (isset($_POST[&#39;prevemps&#39;])) {
            $startrow -= NUMRECORDSPERPAGE;
            if ($startrow &lt; 1) {
                $startrow = 1;
            }
        } else if (isset($_POST[&#39;nextemps&#39;])) {
            $startrow += NUMRECORDSPERPAGE;
        }
    }
    return($startrow);
}
</pre>
<p>The rows will be displayed with a form having <span class="bold">Next</span> and <span class="bold">Previous</span> buttons. The calculation for the starting row depends on which button was clicked and whereabouts in the data set the user has got to.</p>
<p>Add <code><a id="sthref164"></a><a id="sthref165"></a><a id="sthref166"></a>printrecords()</code> to <code>ac_emp_list.php</code> to show any fetched records:</p>
<pre>/**
 * Print the Employee records
 *
 * @param Session <a id="sthref167"></a><a id="sthref168"></a>$sess
 * @param boolean <a id="sthref169"></a><a id="sthref170"></a>$atfirstrow True if the first array entry is the first table row
 * @param array <a id="sthref171"></a><a id="sthref172"></a>$res Array of rows to print
 */
function printrecords($sess, $atfirstrow, $res) {
    echo &lt;&lt;&lt; EOF
        &lt;table border=&#39;1&#39;&gt;
        &lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Phone Number&lt;/th&gt;&lt;th&gt;Equipment&lt;/th&gt;&lt;/tr&gt;
EOF;
    foreach ($res as $row) {
        $name = htmlspecialchars($row[&#39;NAME&#39;], ENT_NOQUOTES, &#39;UTF-8&#39;);
        $pn   = htmlspecialchars($row[&#39;PHONE_NUMBER&#39;], ENT_NOQUOTES, &#39;UTF-8&#39;);
        $eid  = (int)$row[&#39;EMPLOYEE_ID&#39;];
        echo &#34;&lt;tr&gt;&lt;td&gt;$name&lt;/td&gt;&#34;;
        echo &#34;&lt;td&gt;$pn&lt;/td&gt;&#34;;
        echo &#34;&lt;td&gt;&lt;a href=&#39;ac_show_equip.php?empid=$eid&#39;&gt;Show&lt;/a&gt; &#34;;
        if ($sess-&gt;isPrivilegedUser()) {
            echo &#34;&lt;a href=&#39;ac_add_one.php?empid=$eid&#39;&gt;Add One&lt;/a&gt;&#34;;
            echo &#34;&lt;a href=&#39;ac_add_multi.php?empid=$eid&#39;&gt; Add Multiple&lt;/a&gt;\n&#34;;
        }
        echo &#34;&lt;/td&gt;&lt;/tr&gt;\n&#34;;
    }
    echo &#34;&lt;/table&gt;&#34;;
    printnextprev($atfirstrow, count($res));
}
</pre>
<p>This function&#39;s logic is similar to that shown in <code>test_db.php</code>. Remember the &#39;EOF;&#39; token must be at the start of the line and not have any trailing white space.</p>
<p>Privileged users see extra links to issue pieces of equipment to each employee. At the end of the HTML table any <span class="bold">Next</span> and <span class="bold">Previous</span> buttons are shown by calling <code>printnextprev()</code>.</p>
<p>Add <code><a id="sthref173"></a><a id="sthref174"></a><a id="sthref175"></a>printnextprev()</code> to <code>ac_emp_list.php</code>:</p>
<pre>/**
 * Print Next/Previous buttons as needed to page through the records
 *
 * @param boolean <a id="sthref176"></a><a id="sthref177"></a>$atfirstrow True if the first array entry is the first table row
 * @param integer <a id="sthref178"></a><a id="sthref179"></a>$numrows Number of rows the current query retrieved
 */
function printnextprev($atfirstrow, $numrows) {
    if (!$atfirstrow || $numrows == NUMRECORDSPERPAGE) {
        echo &#34;&lt;form method=&#39;post&#39; action=&#39;ac_emp_list.php&#39;&gt;&lt;div&gt;&#34;;
        if (!$atfirstrow)
            echo &#34;&lt;input type=&#39;submit&#39; value=&#39;&lt; Previous&#39; name=&#39;prevemps&#39;&gt;&#34;;
        if ($numrows == NUMRECORDSPERPAGE)
            echo &#34;&lt;input type=&#39;submit&#39; value=&#39;Next &gt;&#39; name=&#39;nextemps&#39;&gt;&#34;;
        echo &#34;&lt;/div&gt;&lt;/form&gt;\n&#34;;
    }
}
</pre>
<p>The <code><a id="sthref180"></a><a id="sthref181"></a><a id="sthref182"></a>printnextprev()</code> logic handles the boundary cases including</p>
<ul>
<li>
<p>not displaying a <span class="bold">Previous</span> button on the first page</p>
</li>
<li>
<p>not showing a <span class="bold">Next</span> button when a full page wasn&#39;t displayed.</p>
</li>
</ul>
<p>Finally, add <a id="sthref183"></a><a id="sthref184"></a><a id="sthref185"></a><code>printnorecords()</code> to <code>ac_emp_list.php</code> to display a message when there are no records to show:</p>
<pre>/**
 * Print a message that there are no records
 *
 * This can be because the table is empty or the final page of results
 * returned no more records
 */
function printnorecords() {
    if (!isset($_POST[&#39;nextemps&#39;])) {
        echo &#34;&lt;p&gt;No Records Found&lt;/p&gt;&#34;;
    } else {
        echo &lt;&lt;&lt;EOF
            &lt;p&gt;No More Records&lt;/p&gt;
            &lt;form method=&#39;post&#39; action=&#39;ac_emp_list.php&#39;&gt;
            &lt;input type=&#39;submit&#39; value=&#39;&lt; Previous&#39; name=&#39;prevemps&#39;&gt;&lt;/form&gt;
EOF;
    }
}
</pre>
<div class="infobox-note">
<p class="notep1">Note:</p>
The <code>EOF;</code> token must be at the start of a line and not have trailing white space.</div>
<p>There are two cases here, one where the table has no rows, and the other when the user is paging through the table and clicking <span class="bold">Next</span> gives no more data to display. This latter case will occur when the number of rows in the table is a multiple of <code>NUM<a id="sthref186"></a><a id="sthref187"></a>RECORDSPERPAGE</code>.</p>
<p>Beforethe application can run, the <a id="sthref188"></a><code>Db::execFetchPage()</code> method must be created. In the file <code>ac_db.inc.php</code> add a new method to the <a id="sthref189"></a><code>Db</code> class:</p>
<pre>    /**
     * Run a query and return a subset of records.  Used for paging through
     * a resultset.
     *
     * The query is used as an embedded subquery.  Do not permit user
     * generated content in $sql because of the SQL Injection security issue
     *
     * @param string <a id="sthref190"></a><a id="sthref191"></a>$sql The query to run
     * @param string <a id="sthref192"></a><a id="sthref193"></a>$action Action text for End-to-End Application Tracing
     * @param integer <a id="sthref194"></a><a id="sthref195"></a>$firstrow The first row number of the data set to return
     * @param integer <a id="sthref196"></a><a id="sthref197"></a>$numrows The number of rows to return
     * @param array <a id="sthref198"></a><a id="sthref199"></a>$bindvars Binds. An array of (bv_name, php_variable, length)
     * @return array Returns an array of rows
     */
    public function execFetchPage($sql, $action, $firstrow = 1, $numrows = 1,
    $bindvars = array()) {
        //
        $query = &#39;SELECT *
            FROM (SELECT a.*, ROWNUM AS rnum
                  FROM (&#39; . $sql . &#39;) a
                  WHERE ROWNUM &lt;= :sq_last)
            WHERE :sq_first &lt;= RNUM&#39;;
 
        // Set up bind variables.
        array_push($bindvars, array(&#39;:sq_first&#39;, $firstrow, -1));
        array_push($bindvars, array(&#39;:sq_last&#39;, $firstrow + $numrows - 1, -1));
        $res = $this-&gt;execFetchAll($query, $action, $bindvars);
        return($res);
    }
</pre>
<p>Oracle Database does not have a <code>LIMIT</code> clause to return a subset of rows so nesting the caller&#39;s query is needed. PHP&#39;s <code><a id="sthref200"></a><a id="sthref201"></a><a id="sthref202"></a>array_push()</code> function appends the extra bind variables used for the start and end row numbers in the outer query to any bind variables for the caller&#39;s query.</p>
<p>Because the SQL text is concatenated watch out for SQL injection issues. Never pass user input into this function.</p>
</div>
<!-- class="sect1" -->
<a id="BABHEHGJ"></a>
<div class="sect1">
<h2 class="sect1">Running the Employee List</h2>
<p>Save all the files and run the application. Login first as <code>Simon</code>. You will see:</p>
<img width="766" height="284" src="img/chap5_paging.png" alt="Employee text"/><br/>
<p>Click <span class="bold">Logout</span>. Re-login as <code>Administrator</code>. You will see:</p>
<img width="766" height="284" src="img/chap5_paging_administrator.png" alt="Employee list"/><br/>
<p>Use the <span class="bold">Next</span> and <span class="bold">Previous</span> buttons to page through the data.</p>
<p>Try changing <a id="sthref203"></a><a id="sthref204"></a><code>NUMRECORDSPERPAGE</code> to see the effect on paging.</p>
</div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment4949">
<tr>
<td class="cellalignment4956">
<table class="cellalignment4954">
<tr>
<td class="cellalignment4953"><a href="ch_four_anyco_app.htm"><img width="24" height="24" src="../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment4953"><a href="ch_six_ref_cur.htm"><img width="24" height="24" src="../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2010, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment4958">
<table class="cellalignment4952">
<tr>
<td class="cellalignment4953"><a href="../index.htm"><img width="24" height="24" src="../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment4953"><a href="../nav/portal_booklist.htm"><img width="24" height="24" src="../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment4953"><a href="toc.htm"><img width="24" height="24" src="../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment4953"><a href="index.htm"><img width="24" height="24" src="../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment4953"><a href="../nav/mindx.htm"><img width="24" height="24" src="../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment4953"><a href="../dcommon/html/feedback.htm"><img width="24" height="24" src="../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>


</body></html>