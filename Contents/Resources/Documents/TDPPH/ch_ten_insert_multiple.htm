<!DOCTYPE html><html lang="en"><head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<meta charset="utf-8"/>
<a class="dashingAutolink" name="autolink-106351"></a><a class="dashAnchor" name="//apple_ref/cpp/Package/Inserting%20Multiple%20Data%20Values"></a><title>Inserting Multiple Data Values</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 743"/>
<meta name="dcterms.created" content="2014-02-04T21:52:15Z"/>
<meta name="robots" content="all"/>
<meta name="dcterms.title" content="Database 2 Day + PHP Developer&#39;s Guide"/>
<meta name="dcterms.identifier" content="E18554-05"/>
<meta name="dcterms.isVersionOf" content="TDPPH"/>
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2010, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved."/>
<link rel="Start" href="../index.htm" title="Home" type="text/html"/>
<link rel="Copyright" href="../dcommon/html/cpyr.htm" title="Copyright" type="text/html"/>

<script type="application/javascript" src="../dcommon/js/headfoot.js"></script>
<script type="application/javascript" src="../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html"/>
<link rel="Index" href="index.htm" title="Index" type="text/html"/>
<link rel="Prev" href="ch_nine_insert.htm" title="Previous" type="text/html"/>
<link rel="Next" href="ch_eleven_image.htm" title="Next" type="text/html"/>
<link rel="alternate" href="E18554-05.pdf" title="PDF version" type="application/pdf"/>
<link rel="schema.dcterms" href="http://purl.org/dc/terms/"/>
<link rel="stylesheet" href="../dcommon/css/fusiondoc.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/header.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/footer.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/fonts.css"/>
<link rel="stylesheet" href="../dcommon/css/foundation.css"/>
<link rel="stylesheet" href="../dcommon/css/codemirror.css"/>
<link rel="stylesheet" type="text/css" title="Default" href="../nav/css/html5.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-480-tablet.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-768-laptop.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-1140-deskop.css"/>
<script type="application/javascript" src="../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="/s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">13/18</span> <!-- End Header -->
<div id="TDPPH177" class="chapter"><a id="sthref244"></a>
<h1 class="chapter"><span class="secnum">10</span> Inserting Multiple Data Values</h1>
<p>PHP OCI8 can insert arrays of characters or integers in one call. This reduces network traffic and database system overhead when inserting multiple values into a table.</p>
<p>This chapter contains the following topics:</p>
<ul>
<li>
<p><a href="#CIACDIDB">Creating the Multiple Insert Form</a></p>
</li>
<li>
<p><a href="#CIAFECFI">Running the Multiple Insert Form</a></p>
</li>
</ul>
<a id="CIACDIDB"></a>
<div id="TDPPH178" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Creating the Multiple Insert Form</h2>
<p>The example in this chapter shows a form allowing three data values to be inserted in one operation.</p>
<p>The array insert is done using a PL/SQL bulk <code>FORALL</code> command. Login to SQL*Plus as <code>HR</code> and create a PL/SQL package:</p>
<pre>CREATE OR REPLACE PACKAGE equip_pkg AS
    TYPE arrtype IS TABLE OF VARCHAR2(20) INDEX BY PLS_INTEGER;
    PROCEDURE insert_equip(eid_p IN NUMBER, eqa_p IN arrtype);
END equip_pkg;
/
</pre>
<pre>CREATE OR REPLACE PACKAGE BODY equip_pkg AS
    PROCEDURE insert_equip(eid_p IN NUMBER, eqa_p IN arrtype) IS
    BEGIN
        FORALL i IN INDICES OF eqa_p
            INSERT INTO equipment (employee_id, equip_name) 
                                   VALUES (eid_p, eqa_p(i));
    END insert_equip;
END equip_pkg;
/
</pre>
<p>The <code>insert_equip()</code> procedure accepts an array of equipment names and inserts them in to the <code>EQUIPMENT</code> table.</p>
<p>Create a new PHP file <code>ac_add_multi.php</code> and copy the contents of <code>ac_add_one.php</code> to it. Carefully make the following changes to convert it to handle an array of values.</p>
<p>In the HTML form in <code>ac_add_multi.php</code>, change the one input field from:</p>
<pre>&lt;div&gt;
    Equipment name &lt;input type=&#34;text&#34; name=&#34;equip&#34;&gt;&lt;br&gt;
    &lt;input type=&#34;hidden&#34; name=&#34;empid&#34; value=&#34;$empid&#34;&gt;
...
</pre>
<p>to three input fields:</p>
<pre>...
&lt;div&gt;
    Equipment name &lt;input type=&#34;text&#34; name=&#34;equip[]&#34;&gt;&lt;br&gt;
    Equipment name &lt;input type=&#34;text&#34; name=&#34;equip[]&#34;&gt;&lt;br&gt;
    Equipment name &lt;input type=&#34;text&#34; name=&#34;equip[]&#34;&gt;&lt;br&gt;
    &lt;input type=&#34;hidden&#34; name=&#34;empid&#34; value=&#34;$empid&#34;&gt;
...
</pre>
<p>Note the <code>[]</code> tokens to return an array, which were not needed in <code>ac_add_one.php</code>.</p>
<p>Replace the <code>getcleanequip()</code> function in <code>ac_add_multi.php</code> so it handles the array of returned form values:</p>
<pre>/**
 * Perform validation and data cleaning so empty strings are not inserted
 *
 * @return array The array of new data to enter
 */
function getcleanequip() {
    if (!isset($_POST[&#39;equip&#39;])) {
        return array();
    } else {
        $equiparr = array();
        foreach ($_POST[&#39;equip&#39;] as $v) {     // Strip out unset values
            $v = trim($v);
            if (!empty($v))
                $equiparr[] = $v;
        }
        return($equiparr);
    }
}
</pre>
<p>This loops along each of the array entries and only returns non empty strings.</p>
<p>Finally, replace <code>doinsert()</code> in <code>ac_add_multi.php</code> with:</p>
<pre>/**
 * Insert an array of equipment values for an employee
 *
 * @param Db $db
 * @param array $equiparr array of string values to be inserted
 * @param string $empid Employee identifier
 */
function doinsert($db, $equiparr, $empid) {
    $arraybinds = array(array(&#34;eqa&#34;, $equiparr, SQLT_CHR));
    $otherbinds = array(array(&#34;eid&#34;, $empid, -1));
    $sql = &#34;BEGIN equip_pkg.insert_equip(:eid, :eqa); END;&#34;;
    $db-&gt;arrayInsert($sql, &#34;Insert Equipment List&#34;, $arraybinds, $otherbinds);
}
</pre>
<p>This uses a new <code>arrayInsert()</code> method in the <code>Db</code> class to call the PL/SQL <code>insert_equip()</code> procedure. The data value arrays must be bound differently from normal scalar PHP OCI8 binds, so the bind parameters to <code>arrayInsert()</code> are separated into two kinds.</p>
<p>Edit ac_db.inc.php and add the new method:</p>
<pre>    /**
     * Insert an array of values by calling a PL/SQL procedure
     *
     * Call like Db::arrayinsert(&#34;begin myproc(:arn, :p); end&#34;,
     *                               &#34;Insert stuff&#34;,
     *                               array(array(&#34;:arn&#34;, $dataarray, SQLT_CHR)),
     *                               array(array(&#34;:p&#34;, $p, -1)))
     *
     * @param string $sql PL/SQL anonymous block
     * @param string $action Action text for End-to-End Application Tracing
     * @param array $arraybindvars Bind variables. An array of tuples
     * @param array $otherbindvars  Bind variables. An array of tuples
     */
    public function arrayInsert($sql, $action, $arraybindvars, 
    $otherbindvars = array()) {
        $this-&gt;stid = oci_parse($this-&gt;conn, $sql);
        foreach ($arraybindvars as $a) {
            // oci_bind_array_by_name(resource, bv_name, 
            // php_array, php_array_length, max_item_length, datatype)
            oci_bind_array_by_name($this-&gt;stid, $a[0], $a[1], 
            count($a[1]), -1, $a[2]);
        }
        foreach ($otherbindvars as $bv) {
            // oci_bind_by_name(resource, bv_name, php_variable, length)
            oci_bind_by_name($this-&gt;stid, $bv[0], $bv[1], $bv[2]);
        }
        oci_set_action($this-&gt;conn, $action);
        oci_execute($this-&gt;stid);              // will auto commit
                $this-&gt;stid = null;
    }
</pre>
<p>Binding in <code>Db::arrayInsert()</code> is similar to the example previously shown in this manual. The <code>oci_bind_array_by_name()</code> function takes slightly different arguments, since the number of elements in data array must now be passed in. In the AnyCo application <code>oci_bind_array_by_name</code> is being used only for inserting data from PHP so the maximum data length parameter can be passed as <code>-1</code>. This tells PHP to use the actual value lengths. The single <code>oci_execute()</code> call inserts all the data items into the database.</p>
</div>
<!-- class="sect1" -->
<a id="CIAFECFI"></a>
<div id="TDPPH179" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Running the Multiple Insert Form</h2>
<p>Save the files and run the AnyCo application in a browser. Log in as <code>Administrator</code> and click the <span class="bold">Add Multiple</span> link for Steven King.</p>
<img width="766" height="287" src="img/chap1_overview.png" alt="Employee list with Add Multiple link"/><br/>
<p>Add some data items such as <code>Computer</code>, <code>Monitor</code>, and <code>Keyboard</code>.</p>
<img width="725" height="218" src="img/chap10_multiple_insert.png" alt="The multiple insert form"/><br/>
<p>Click <span class="bold">Submit</span> and and then click <span class="bold">Show</span> next to Steven King to check that the data items are inserted.</p>
<img width="736" height="303" src="img/chap10_multiple.png" alt="Multiple entry"/><br/>
<p>Array binding also works for fetching data. PL/SQL procedures using the efficient <code>BULK COLLECT</code> syntax can return data to PHP in one OCI8 <code>oci_execute()</code> call. For retrieving data from Oracle the <code>oci_bind_array_by_name()</code> call would need to know how many items and what the maximum data size is so PHP can allocate the memory correctly.</p>
</div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment4949">
<tr>
<td class="cellalignment4956">
<table class="cellalignment4954">
<tr>
<td class="cellalignment4953"><a href="ch_nine_insert.htm"><img width="24" height="24" src="../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment4953"><a href="ch_eleven_image.htm"><img width="24" height="24" src="../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2010, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment4958">
<table class="cellalignment4952">
<tr>
<td class="cellalignment4953"><a href="../index.htm"><img width="24" height="24" src="../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment4953"><a href="../nav/portal_booklist.htm"><img width="24" height="24" src="../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment4953"><a href="toc.htm"><img width="24" height="24" src="../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment4953"><a href="index.htm"><img width="24" height="24" src="../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment4953"><a href="../nav/mindx.htm"><img width="24" height="24" src="../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment4953"><a href="../dcommon/html/feedback.htm"><img width="24" height="24" src="../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>


</body></html>