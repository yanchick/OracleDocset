<!DOCTYPE html><html lang="en-US"><head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="UTF-8"/>
<a class="dashingAutolink" name="autolink-87883"></a><a class="dashAnchor" name="//apple_ref/cpp/Package/Tuning%20Regressed%20SQL%20Statements%20From%20a%20Remote%20SQL%20Trial%20Using%20APIs"></a><title>Tuning Regressed SQL Statements From a Remote SQL Trial Using APIs</title>
<meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"/>
<meta name="keywords" content="SQL statements, regressed"/>
<meta name="dcterms.created" content="2017-01-24T11:32:44Z"/>
<meta name="robots" content="all"/>
<meta name="dcterms.title" content="Database Testing Guide"/>
<meta name="dcterms.identifier" content="E55028-05"/>
<meta name="dcterms.isVersionOf" content="RATUG"/>
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2008, 2017, Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved."/>
<link rel="Start" href="../index.htm" title="Home" type="text/html"/>
<link rel="Copyright" href="../dcommon/html/cpyr.htm" title="Copyright" type="text/html"/>

<script type="application/javascript" src="../dcommon/js/headfoot.js"></script>
<script type="application/javascript" src="../nav/js/doccd.js" charset="UTF-8"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html"/>
<link rel="Index" href="index.htm" title="Index" type="text/html"/>
<link rel="Prev" href="GUID-B85471DE-CC06-4E02-AFA6-AD207D94C8C8.htm" title="Previous" type="text/html"/>
<link rel="Next" href="GUID-48F67DD6-70B6-49CC-B4B3-72F2D80E6DDD.htm" title="Next" type="text/html"/>
<link rel="alternate" href="E55028-05.pdf" title="PDF version" type="application/pdf"/>
<link rel="schema.dcterms" href="http://purl.org/dc/terms/"/>
<link rel="stylesheet" href="../dcommon/css/fusiondoc.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/header.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/footer.css"/>
<link rel="stylesheet" type="text/css" href="../dcommon/css/fonts.css"/>
<link rel="stylesheet" href="../dcommon/css/foundation.css"/>
<link rel="stylesheet" href="../dcommon/css/codemirror.css"/>
<link rel="stylesheet" type="text/css" title="Default" href="../nav/css/html5.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-480-tablet.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-768-laptop.css"/>
<link rel="stylesheet" href="../dcommon/css/respond-1140-deskop.css"/>
<script type="application/javascript" src="../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="/s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet" href="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen"/>
<script type="text/javascript" src="../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns" dir="ltr">
<a id="BEGIN" name="BEGIN"></a>
<a id="GUID-0B629FA1-FF45-44D0-BB2D-28FF762BC102"></a> <span id="PAGE" style="display:none;">56/309</span> <!-- End Header -->
<a id="RATUG309"></a>
<h1 id="RATUG-GUID-0B629FA1-FF45-44D0-BB2D-28FF762BC102" class="sect1"><span class="enumeration_section">6.2.5</span> Tuning Regressed SQL Statements From a Remote SQL Trial Using APIs</h1>
<div>
<div class="section">
<p>If you chose to execute the SQL workload remotely on a separate database, then you should tune any regressions identified by the SQL trials on the remote database, instead of the system where the SQL Performance Analyzer task resides.</p>
</div>
<!-- class="section" -->
<div class="section">
<p class="subhead1">To tune regressed SQL statements from a remote SQL trial using APIs:</p>
<ol>
<li>
<p>On the system running SQL Performance Analyzer, create a subset of the regressed SQL statements as a SQL tuning set:</p>
<pre dir="ltr">DECLARE
  sqlset_cur  DBMS_SQLTUNE.SQLSET_CURSOR;
BEGIN
  DBMS_SQLTUNE.CREATE_SQLSET(&#39;SUB_STS1&#39;, &#39;test purpose&#39;);
 
  OPEN sqlset_cur FOR
    SELECT value(p)
    FROM table(
      DBMS_SQLTUNE.SELECT_SQLPA_TASK(
        task_name  =&gt; &#39;SPA_TASK1&#39;,
        execution_name =&gt; &#39;COMP&#39;,
        level_filter =&gt; &#39;REGRESSED&#39;)) p;
   
  DBMS_SQLTUNE.LOAD_SQLSET(&#39;SUB_STS1&#39;, sqlset_cur);
 
  CLOSE sqlset_cur;
END;
/
</pre>
<p>Other than <code>&#39;REGRESSED&#39;</code>, you can use other filters to select SQL statements for the SQL tuning set, such as <code>&#39;CHANGED&#39;</code>, <code>&#39;ERRORS&#39;</code>, or <code>&#39;CHANGED_PLANS&#39;</code>. For more information, see <a class="olink ARPLS73150" target="_blank" href="../ARPLS/d_sqltun.htm#ARPLS73150"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a>.</p>
</li>
<li>
<p>Create a staging table to where the SQL tuning set will be exported:</p>
<pre dir="ltr">BEGIN
  DBMS_SQLTUNE.CREATE_STGTAB_SQLSET(
    table_name  =&gt; &#39;STG_TAB1&#39;,
    schema_name =&gt; &#39;JOHNDOE&#39;,
    tablespace_name =&gt; &#39;TBS_1&#39;,
    db_version =&gt; DBMS_SQLTUNE.STS_STGTAB_11_1_VERSION);
END;
/
</pre>
<p>Use the <code>db_version</code> parameter to specify the appropriate database version to where the SQL tuning set will be exported and tuned. In this example, the staging table will be created with a format so that it can be exported to a system running Oracle Database 11<span class="italic">g</span> Release 1, where it will later be tuned using SQL Tuning Advisor. For other database versions, see <a class="olink ARPLS" target="_blank" href="../ARPLS/toc.htm"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a> for that release.</p>
</li>
<li>
<p>Export the SQL tuning set into the staging table:</p>
<pre dir="ltr">BEGIN
  DBMS_SQLTUNE.PACK_STGTAB_SQLSET(
    sqlset_name =&gt; &#39;SUB_STS1&#39;, 
    sqlset_owner =&gt; &#39;JOHNDOE&#39;, 
    staging_table_name =&gt; &#39;STG_TAB1&#39;, 
    staging_schema_owner =&gt; &#39;JOHNDOE&#39;, 
    db_version =&gt; DBMS_SQLTUNE.STS_STGTAB_11_1_VERSION);
END;
/
</pre></li>
<li>
<p>Move the staging table to the remote database (where the SQL workload was executed) using the mechanism of choice (such as Oracle Data Pump or database link).</p>
</li>
<li>
<p>On the remote database, import the SQL tuning set from the staging table:</p>
<pre dir="ltr">BEGIN
  DBMS_SQLTUNE.UNPACK_STGTAB_SQLSET(
    sqlset_name =&gt; &#39;SUB_STS1&#39;, 
    staging_table_name =&gt; &#39;STG_TAB1&#39;, 
    replace =&gt; TRUE);
END;
/
</pre></li>
<li>
<p>Tune the regressed SQL statements in the SQL tuning set by running SQL Tuning Advisor:</p>
<pre dir="ltr">BEGIN
  sts_name  := &#39;SUB_STS1&#39;;
  sts_owner := &#39;JOHNDOE&#39;;
  tune_task_name := &#39;TUNE_TASK1&#39;;
  tname := DBMS_SQLTUNE.CREATE_TUNING_TASK(sqlset_name  =&gt; sts_name, 
                                           sqlset_owner =&gt; sts_owner, 
                                           task_name    =&gt; tune_task_name);
  EXEC DBMS_SQLTUNE.SET_TUNING_TASK_PARAMETER(:tname, 
                                              &#39;APPLY_CAPTURED_COMPILENV&#39;, 
                                              &#39;FALSE&#39;);
  exec_name := DBMS_SQLTUNE.EXECUTE_TUNING_TASK(tname);
END;
/
</pre>
<div class="infobox-note" id="GUID-0B629FA1-FF45-44D0-BB2D-28FF762BC102__GUID-3FFD539E-79F0-449B-8D8C-F9B357A29DD4">
<p class="notep1">Note:</p>
<p>The <code>APPLY_CAPTURED_COMPILENV</code> parameter used in this example is only supported by Oracle Database 11<span class="italic">g</span> Release 1 and newer releases. If you are testing a database upgrade from an earlier version of Oracle Database, SQL Tuning Advisor will use the environment variables stored in the SQL tuning set instead.</p>
</div>
</li>
</ol>
</div>
<!-- class="section" -->
<div class="section">
<p>After tuning the regressed SQL statements, you should test these changes using SQL Performance Analyzer. Run a new SQL trial on the test system, followed by a second comparison (between this new SQL trial and the first SQL trial) to validate your results. Once SQL Performance Analyzer shows that performance has stabilized, implement the fixes from this step to your production system.</p>
<div class="infoboxnotealso" id="GUID-0B629FA1-FF45-44D0-BB2D-28FF762BC102__GUID-7AD96124-4263-4634-95E7-AD45264567AD">
<p class="notep1">See Also:</p>
<ul style="list-style-type: disc;">
<li>
<p><a class="olink TGSQL540" target="_blank" href="../TGSQL/tgsql_sqltune.htm#TGSQL540"><span class="italic">Oracle Database SQL Tuning Guide</span></a> for information about using the SQL Tuning Advisor and transporting SQL tuning sets</p>
</li>
<li>
<p><a class="olink ARPLS220" target="_blank" href="../ARPLS/d_sqltun.htm#ARPLS220"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a> for information about the <code>DBMS_SQLTUNE</code> package</p>
</li>
</ul>
</div>
</div>
<!-- class="section" --></div>
</div>
<!-- class="ind" --><!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment2747">
<tr>
<td class="cellalignment2754">
<table class="cellalignment2752">
<tr>
<td class="cellalignment2751"><a href="GUID-B85471DE-CC06-4E02-AFA6-AD207D94C8C8.htm"><img width="24" height="24" src="../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment2751"><a href="GUID-48F67DD6-70B6-49CC-B4B3-72F2D80E6DDD.htm"><img width="24" height="24" src="../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2008, 2017, Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment2756">
<table class="cellalignment2750">
<tr>
<td class="cellalignment2751"><a href="../index.htm"><img width="24" height="24" src="../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment2751"><a href="../nav/portal_booklist.htm"><img width="24" height="24" src="../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment2751"><a href="toc.htm"><img width="24" height="24" src="../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment2751"><a href="index.htm"><img width="24" height="24" src="../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment2751"><a href="../nav/mindx.htm"><img width="24" height="24" src="../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment2751"><a href="../dcommon/html/feedback.htm"><img width="24" height="24" src="../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>


</body></html>